<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathQuestAdventure | Epic Math Battle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Fredoka+One&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #f72585;
            --secondary: #4361ee;
            --accent: #4cc9f0;
            --success: #4caf50;
            --danger: #ff6b6b;
            --warning: #ffd700;
            --dark: #0a0a2a;
            --light: #ffffff;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #000428 0%, #004e92 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* ===== CELEBRATION ANIMATIONS ===== */
        .celebration-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            display: none;
        }

        .celebration-container.active {
            display: block;
        }

        .firework {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: firework 1.5s ease-out forwards;
        }

        @keyframes firework {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            50% {
                transform: translate(var(--x), var(--y)) scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: translate(calc(var(--x) * 2), calc(var(--y) * 2)) scale(0);
                opacity: 0;
            }
        }

        .celebration-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 5rem;
            font-weight: 900;
            text-align: center;
            animation: celebrationText 3s ease-out forwards;
            text-shadow: 0 0 30px var(--warning);
            white-space: nowrap;
        }

        @keyframes celebrationText {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -150%) scale(0.5);
            }
        }

        .star-rain {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .star {
            position: absolute;
            color: var(--warning);
            font-size: 1.5rem;
            animation: starFall 2s linear forwards;
        }

        @keyframes starFall {
            0% {
                transform: translateY(-10vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(110vh) rotate(360deg);
                opacity: 0;
            }
        }

        .confetti-piece {
            position: fixed;
            width: 15px;
            height: 15px;
            background: var(--accent);
            top: -20px;
            z-index: 1000;
            pointer-events: none;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* ===== MUSIC CONTROLS ===== */
        .music-controls-minimal {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            gap: 10px;
        }

        .music-btn-minimal {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border: 2px solid var(--accent);
            color: var(--accent);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            font-size: 1.2rem;
        }

        .music-btn-minimal:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 8px 25px var(--accent);
            background: var(--accent);
            color: black;
        }

        .music-btn-minimal.muted {
            opacity: 0.5;
            border-color: var(--danger);
            color: var(--danger);
        }

        .volume-control {
            position: absolute;
            top: 70px;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid var(--accent);
            border-radius: 20px;
            padding: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
            min-width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .volume-control.show {
            display: block;
        }

        .volume-slider-minimal {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            outline: none;
            margin: 10px 0;
        }

        .volume-slider-minimal::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent);
            transition: var(--transition-smooth);
        }

        .volume-slider-minimal::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .volume-label {
            display: flex;
            justify-content: space-between;
            color: var(--accent);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .track-selector {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .track-title {
            text-align: center;
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .track-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .track-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--accent);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition-smooth);
            min-width: 80px;
        }

        .track-btn:hover {
            background: var(--accent);
            color: black;
            transform: translateY(-2px);
        }

        .track-btn.active {
            background: var(--accent);
            color: black;
            font-weight: bold;
        }

        .status-text {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--warning);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== ANIMATED BACKGROUND ===== */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
        }

        .bg-particle {
            position: absolute;
            background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
            border-radius: 50%;
            animation: floatParticle 20s infinite linear;
            will-change: transform, opacity;
        }

        @keyframes floatParticle {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.3;
            }
            90% {
                opacity: 0.3;
            }
            100% {
                transform: translateY(-100px) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* ===== CONTAINER ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* ===== SCREENS ===== */
        .screen {
            display: none;
            opacity: 0;
            animation: screenSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            will-change: transform, opacity;
        }

        .screen.active {
            display: block;
        }

        @keyframes screenSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Name Input Styling */
        .name-input {
            width: 100%;
            padding: 20px 30px;
            font-size: 1.2rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--accent);
            border-radius: 20px;
            color: white;
            font-family: 'Poppins', sans-serif;
            outline: none;
            transition: var(--transition-smooth);
            margin-bottom: 30px;
        }

        .name-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(247, 37, 133, 0.3);
            transform: translateY(-2px);
        }

        .name-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        /* ===== PREMIUM START SCREEN ===== */
        #start-screen.active {
            padding: 40px 20px;
        }

        .game-logo {
            text-align: center;
            margin-bottom: 60px;
            position: relative;
        }

        .game-logo h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 5rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 20px;
            text-shadow: 0 0 50px rgba(76, 201, 240, 0.5);
            animation: logoGlow 3s ease-in-out infinite;
        }

        @keyframes logoGlow {
            0%, 100% {
                text-shadow: 0 0 50px rgba(76, 201, 240, 0.5),
                             0 0 100px rgba(67, 97, 238, 0.3);
            }
            50% {
                text-shadow: 0 0 80px rgba(76, 201, 240, 0.8),
                             0 0 150px rgba(67, 97, 238, 0.5),
                             0 0 200px rgba(247, 37, 133, 0.3);
            }
        }

        .game-tagline {
            font-size: 1.5rem;
            color: var(--accent);
            margin-bottom: 10px;
            font-weight: 300;
        }

        .game-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Premium Character Selection */
        .character-selection-pro {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            margin: 40px auto;
            max-width: 900px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: var(--transition-smooth);
        }

        .character-selection-pro:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.5);
        }

        .character-selection-pro::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: var(--accent);
            margin-bottom: 30px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .characters-pro {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .char-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-bounce);
            position: relative;
            overflow: hidden;
            will-change: transform;
        }

        .char-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(76, 201, 240, 0.3);
        }

        .char-card.selected {
            border-color: var(--primary);
            background: linear-gradient(145deg, 
                rgba(247, 37, 133, 0.1), 
                rgba(67, 97, 238, 0.1));
            box-shadow: 0 20px 50px rgba(247, 37, 133, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            animation: selectedPulse 2s infinite;
        }

        @keyframes selectedPulse {
            0%, 100% {
                box-shadow: 0 20px 50px rgba(247, 37, 133, 0.4);
            }
            50% {
                box-shadow: 0 20px 70px rgba(247, 37, 133, 0.6);
            }
        }

        .char-icon-pro {
            font-size: 4rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            transition: var(--transition-smooth);
        }

        .char-card.selected .char-icon-pro {
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-15px);
            }
        }

        .char-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: white;
        }

        .char-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .char-bonuses {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .bonus-tag {
            background: rgba(76, 201, 240, 0.1);
            border: 1px solid var(--accent);
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.8rem;
            color: var(--accent);
            transition: var(--transition-smooth);
        }

        .bonus-tag:hover {
            background: rgba(76, 201, 240, 0.2);
            transform: scale(1.05);
        }

        /* Difficulty Selection Pro */
        .difficulty-pro {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            margin: 40px auto;
            max-width: 800px;
        }

        .difficulty-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .diff-btn-pro {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 25px 40px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition-bounce);
            position: relative;
            overflow: hidden;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            will-change: transform;
        }

        .diff-btn-pro::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s;
        }

        .diff-btn-pro:hover::before {
            left: 100%;
        }

        .diff-btn-pro:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(76, 201, 240, 0.3);
        }

        .diff-btn-pro.active {
            background: linear-gradient(145deg, 
                rgba(67, 97, 238, 0.2), 
                rgba(247, 37, 133, 0.2));
            border-color: var(--primary);
            box-shadow: 0 20px 50px rgba(247, 37, 133, 0.4);
        }

        .diff-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Game Stats Pro */
        .stats-pro {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 800px;
            margin: 40px auto;
        }

        .stat-card-pro {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            transition: var(--transition-smooth);
        }

        .stat-card-pro:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(76, 201, 240, 0.2);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
            color: white;
        }

        /* Premium Buttons */
        .btn-premium {
            background: linear-gradient(145deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 50px;
            padding: 20px 50px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-bounce);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 40px rgba(247, 37, 133, 0.4);
            margin: 30px auto;
            min-width: 300px;
            justify-content: center;
            will-change: transform;
        }

        .btn-premium::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .btn-premium:hover::before {
            left: 100%;
        }

        .btn-premium:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 60px rgba(247, 37, 133, 0.6);
        }

        .btn-premium:active {
            transform: translateY(-2px) scale(1.02);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 15px 30px;
            border-radius: 50px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-outline:hover {
            background: rgba(76, 201, 240, 0.1);
            transform: translateY(-3px);
        }

        /* Game Screen Premium */
        #game-screen.active {
            padding: 20px;
        }

        .game-header-pro {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 25px 40px;
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transition: var(--transition-smooth);
        }

        .game-header-pro:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
        }

        .player-info-pro {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .char-display {
            background: linear-gradient(145deg, var(--primary), var(--secondary));
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 10px 30px rgba(247, 37, 133, 0.4);
            transition: var(--transition-smooth);
            animation: charPulse 3s infinite;
        }

        @keyframes charPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .player-stats-pro {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }

        .stat-badge {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 150px;
            transition: var(--transition-smooth);
        }

        .stat-badge:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
            background: rgba(76, 201, 240, 0.1);
        }

        .stat-badge i {
            font-size: 1.5rem;
            color: var(--accent);
            animation: iconSpin 10s infinite linear;
        }

        @keyframes iconSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .stat-value-pro {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
        }

        .game-controls-pro {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .timer-pro {
            background: linear-gradient(145deg, #ff6b6b, #ff4757);
            border-radius: 20px;
            padding: 20px 30px;
            text-align: center;
            min-width: 150px;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            animation: timerPulsePro 1s infinite;
            transition: var(--transition-smooth);
        }

        .timer-pro:hover {
            transform: scale(1.05);
        }

        @keyframes timerPulsePro {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            }
            50% {
                box-shadow: 0 10px 50px rgba(255, 107, 107, 0.6);
            }
        }

        .timer-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 5px;
        }

        /* Battle Arena Pro */
        .battle-arena {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            transition: var(--transition-smooth);
        }

        .battle-arena:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .battle-arena::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .combatants {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 50px;
        }

        .combatant {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            flex: 1;
            transition: var(--transition-smooth);
        }

        .combatant:hover {
            transform: scale(1.05);
        }

        .combatant-icon {
            font-size: 5rem;
            animation: combatantFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px currentColor);
        }

        @keyframes combatantFloat {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            25% {
                transform: translateY(-20px) rotate(5deg);
            }
            75% {
                transform: translateY(10px) rotate(-5deg);
            }
        }

        .enemy-icon {
            color: var(--danger);
            text-shadow: 0 0 40px rgba(255, 107, 107, 0.5);
        }

        .hero-icon {
            color: var(--accent);
            text-shadow: 0 0 40px rgba(76, 201, 240, 0.5);
        }

        .health-bar-pro {
            width: 250px;
            height: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--glass-border);
            position: relative;
        }

        .health-fill-pro {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #2e7d32);
            width: 100%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            will-change: width;
        }

        .health-fill-pro::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: healthShine 2s infinite;
        }

        @keyframes healthShine {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .enemy .health-fill-pro {
            background: linear-gradient(90deg, #ff6b6b, #ff4757);
        }

        /* Question Area Pro */
        .question-area {
            text-align: center;
            margin: 40px 0;
        }

        .question-card {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            border: 2px solid var(--accent);
            border-radius: 25px;
            padding: 40px;
            margin: 30px auto;
            max-width: 800px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(76, 201, 240, 0.3);
            transition: var(--transition-smooth);
        }

        .question-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 70px rgba(76, 201, 240, 0.4);
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        /* Compact Timer inside question card */
        .compact-timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--accent);
            border-radius: 15px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: white;
            box-shadow: 0 0 20px rgba(76, 201, 240, 0.3);
            transition: all 0.3s ease;
        }

        .compact-timer.warning {
            border-color: var(--danger);
            box-shadow: 0 0 20px var(--danger);
            animation: timerWarning 0.5s infinite;
        }

        @keyframes timerWarning {
            0%, 100% {
                border-color: var(--danger);
                box-shadow: 0 0 20px var(--danger);
            }
            50% {
                border-color: var(--warning);
                box-shadow: 0 0 30px var(--warning);
            }
        }

        .compact-timer i {
            color: var(--accent);
            font-size: 1.2rem;
            animation: timerIconSpin 2s infinite linear;
        }

        @keyframes timerIconSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .compact-timer.warning i {
            color: var(--danger);
        }

        #question {
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            color: white;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(76, 201, 240, 0.5);
            padding-right: 80px;
            transition: var(--transition-smooth);
        }

        .question-meta {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .retry-badge {
            display: inline-block;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid var(--danger);
            border-radius: 15px;
            padding: 5px 15px;
            color: var(--danger);
            font-size: 0.9rem;
            margin-left: 15px;
            animation: retryPulse 2s infinite;
        }

        @keyframes retryPulse {
            0%, 100% {
                opacity: 0.8;
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        /* Options Grid Pro */
        .options-grid-pro {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 800px;
            margin: 40px auto;
        }

        .option-btn-pro {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            font-size: 1.8rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: var(--transition-bounce);
            position: relative;
            overflow: hidden;
            will-change: transform;
        }

        .option-btn-pro:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(76, 201, 240, 0.3);
        }

        .option-btn-pro.correct {
            background: linear-gradient(145deg, #4caf50, #2e7d32);
            border-color: #4caf50;
            animation: correctBounce 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes correctBounce {
            0%, 100% {
                transform: scale(1);
            }
            30% {
                transform: scale(1.1);
            }
            60% {
                transform: scale(0.95);
            }
        }

        .option-btn-pro.wrong {
            background: linear-gradient(145deg, #ff6b6b, #ff4757);
            border-color: #ff6b6b;
            animation: wrongShakePro 0.5s ease;
        }

        @keyframes wrongShakePro {
            0%, 100% {
                transform: translateX(0);
            }
            20%, 60% {
                transform: translateX(-10px);
            }
            40%, 80% {
                transform: translateX(10px);
            }
        }

        .option-btn-pro:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .option-btn-pro.hint-removed {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: #666;
            background: rgba(0, 0, 0, 0.5);
            pointer-events: none;
            text-decoration: line-through;
        }

        /* Feedback Area */
        .feedback-pro {
            text-align: center;
            margin: 40px auto;
            max-width: 800px;
        }

        .feedback-message {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 25px;
            font-size: 1.3rem;
            margin-bottom: 20px;
            animation: feedbackSlide 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: none;
            will-change: transform, opacity;
        }

        @keyframes feedbackSlide {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-message.show {
            display: block;
        }

        .feedback-message.correct {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
            color: #a5d6a7;
        }

        .feedback-message.wrong {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            color: #ffabab;
        }

        /* Progress Tracking */
        .progress-tracker {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            margin: 40px auto;
            max-width: 800px;
            transition: var(--transition-smooth);
        }

        .progress-tracker:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .progress-bar-pro {
            height: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill-pro {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            will-change: width;
        }

        .progress-fill-pro::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShine 2s infinite;
        }

        @keyframes progressShine {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        /* ===== PREMIUM ANIMATIONS ===== */
        .damage-float {
            position: absolute;
            color: var(--danger);
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 900;
            animation: damageFloat 1s ease-out forwards;
            pointer-events: none;
            text-shadow: 0 0 10px var(--danger);
            z-index: 100;
        }

        @keyframes damageFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px) scale(1.5);
                opacity: 0;
            }
        }

        /* VS Pulse animation */
        @keyframes vsPulse {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(247, 37, 133, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 10px 50px rgba(247, 37, 133, 0.6);
                transform: scale(1.1);
            }
        }

        /* Skill Effect Animation */
        @keyframes skillEffect {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            80% { opacity: 1; transform: translate(-50%, -150%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -200%) scale(0.5); }
        }

        .skill-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 900;
            z-index: 1000;
            animation: skillEffect 2s ease-in-out forwards;
            pointer-events: none;
            text-align: center;
            text-shadow: 0 0 20px currentColor;
        }

        /* Daily Reward Animation */
        @keyframes rewardPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 30px var(--warning);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 60px var(--warning), 0 0 90px var(--warning);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 30px var(--warning);
            }
        }

        .reward-available {
            animation: rewardPulse 2s infinite !important;
            background: linear-gradient(145deg, var(--warning), #ffaa00) !important;
        }

        @keyframes coinRain {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(200px) rotate(360deg);
                opacity: 0;
            }
        }

        .coin-effect {
            position: fixed;
            width: 30px;
            height: 30px;
            background: gold;
            border-radius: 50%;
            z-index: 1000;
            pointer-events: none;
            animation: coinRain 1.5s ease-out forwards;
            box-shadow: 0 0 20px gold;
        }

        /* Combo Meter */
        .combo-meter {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--warning);
            border-radius: 50px;
            padding: 15px 30px;
            text-align: center;
            z-index: 100;
            animation: comboPulse 0.5s ease;
            backdrop-filter: blur(10px);
        }

        @keyframes comboPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .combo-count {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--warning);
            line-height: 1;
        }

        .combo-multiplier {
            font-size: 1.2rem;
            color: var(--accent);
        }

        .combo-timer {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .combo-timer-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--warning), var(--danger));
            width: 100%;
            transition: width 0.1s linear;
        }

        /* Shop System */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-bounce);
            position: relative;
            overflow: hidden;
        }

        .shop-item:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--warning);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }

        .shop-item.purchased {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .shop-item.purchased:hover {
            transform: none;
        }

        .shop-item-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--warning);
            transition: var(--transition-smooth);
        }

        .shop-item:hover .shop-item-icon {
            transform: rotate(360deg);
        }

        .shop-item-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .shop-item-desc {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 15px;
        }

        .shop-item-price {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--warning);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .shop-item-price i {
            font-size: 1.2rem;
        }

        .shop-item-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--success);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            animation: badgePulse 2s infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Achievement Badges */
        .badge-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .achievement-badge {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--primary), var(--secondary));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: var(--transition-bounce);
            border: 3px solid transparent;
        }

        .achievement-badge.earned {
            border-color: var(--warning);
            box-shadow: 0 0 30px var(--warning);
        }

        .achievement-badge.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-badge:hover {
            transform: scale(1.1) rotate(360deg);
        }

        .badge-icon {
            font-size: 2.5rem;
            color: white;
        }

        .badge-level {
            font-size: 0.8rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
        }

        .badge-tooltip {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            border-radius: 10px;
            width: 150px;
            text-align: center;
            font-size: 0.8rem;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            border: 1px solid var(--warning);
        }

        .achievement-badge:hover .badge-tooltip {
            visibility: visible;
            opacity: 1;
            bottom: 110%;
        }

        /* Leaderboard Global */
        .high-score-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .high-score-tab {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 10px 20px;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .high-score-tab:hover {
            background: rgba(76, 201, 240, 0.1);
            transform: translateY(-2px);
        }

        .high-score-tab.active {
            background: linear-gradient(145deg, var(--primary), var(--secondary));
            color: white;
            border-color: var(--primary);
        }

        /* Achievements Grid */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .achievement-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition-smooth);
        }

        .achievement-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
        }

        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-card.earned {
            border-color: var(--warning);
            background: rgba(255, 215, 0, 0.05);
        }

        .achievement-icon {
            font-size: 1.8rem;
            color: var(--accent);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .achievement-card.earned .achievement-icon {
            color: var(--warning);
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-name {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 0.9rem;
        }

        .achievement-desc {
            font-size: 0.75rem;
            opacity: 0.7;
            line-height: 1.2;
        }

        /* Skill Button Styling */
        .skill-btn {
            background: linear-gradient(145deg, #f72585, #9d4edd);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-bounce);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(247, 37, 133, 0.4);
        }

        .skill-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(247, 37, 133, 0.6);
        }

        .skill-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Retry button styling */
        #retry-btn {
            background: linear-gradient(145deg, #ff8c00, #ff6b00);
        }

        #retry-btn i {
            animation: retrySpin 2s infinite;
        }

        @keyframes retrySpin {
            0% {
                transform: rotate(0deg);
            }
            50% {
                transform: rotate(180deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Skip button styling */
        #skip-btn {
            background: linear-gradient(145deg, #9d4edd, #6a4c93);
        }

        #skip-btn i {
            animation: skipPulse 1.5s infinite;
        }

        @keyframes skipPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        /* Statistics Screen */
        .stats-grid-large {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 40px 0;
        }

        .stat-card-large {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            border: 1px solid var(--glass-border);
            transition: var(--transition-smooth);
        }

        .stat-card-large:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .stat-card-large i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--accent);
        }

        /* Hidden Utility */
        .hidden {
            display: none !important;
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s infinite linear;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid var(--accent);
            border-radius: 50px;
            padding: 15px 30px;
            color: white;
            font-size: 1rem;
            z-index: 10001;
            animation: toastSlide 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        @keyframes toastSlide {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(100px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Smooth transitions for all interactive elements */
        button, .char-card, .diff-btn-pro, .option-btn-pro, .shop-item, .achievement-badge {
            transition: var(--transition-smooth);
        }

        /* Performance optimizations */
        .char-card, .diff-btn-pro, .option-btn-pro, .btn-premium {
            will-change: transform;
        }

        /* Media queries for responsive design */
        @media (max-width: 768px) {
            .game-logo h1 {
                font-size: 3rem;
            }
            
            .options-grid-pro {
                grid-template-columns: 1fr;
            }
            
            .combatants {
                flex-direction: column;
                gap: 30px;
            }
            
            .health-bar-pro {
                width: 200px;
            }
            
            .btn-premium {
                min-width: 250px;
                padding: 15px 30px;
            }
        }
    </style>
</head>
<body>
    <!-- Celebration Container for Level 10 -->
    <div id="celebration-container" class="celebration-container">
        <div class="star-rain" id="star-rain"></div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Combo Meter -->
    <div id="combo-meter" class="combo-meter" style="display: none;">
        <div class="combo-count" id="combo-count">0</div>
        <div class="combo-multiplier" id="combo-multiplier">1.0x</div>
        <div class="combo-timer">
            <div class="combo-timer-fill" id="combo-timer-fill" style="width: 100%;"></div>
        </div>
    </div>

    <!-- Music Controls -->
    <div class="music-controls-minimal">
        <button class="music-btn-minimal" id="music-toggle-btn" title="Toggle Music">
            <i class="fas fa-music"></i>
        </button>
        <button class="music-btn-minimal" id="sfx-toggle-btn" title="Toggle Sound Effects">
            <i class="fas fa-volume-up"></i>
        </button>
        <button class="music-btn-minimal" id="volume-btn" title="Audio Settings">
            <i class="fas fa-sliders-h"></i>
        </button>
        <div class="volume-control" id="volume-control">
            <h4 style="color: var(--accent); margin-bottom: 15px; text-align: center;"> Audio Settings</h4>
            
            <div style="margin-bottom: 15px;">
                <div class="volume-label">
                    <span><i class="fas fa-music"></i> Music Volume</span>
                    <span id="music-vol-value">50%</span>
                </div>
                <input type="range" min="0" max="100" value="50" class="volume-slider-minimal" id="music-volume-slider">
            </div>
            
            <div style="margin-bottom: 15px;">
                <div class="volume-label">
                    <span><i class="fas fa-volume-up"></i> SFX Volume</span>
                    <span id="sfx-vol-value">70%</span>
                </div>
                <input type="range" min="0" max="100" value="70" class="volume-slider-minimal" id="sfx-volume-slider">
            </div>
            
            <div class="track-selector">
                <div class="track-title"> Select Music Track</div>
                <div class="track-buttons">
                    <button class="track-btn active" id="track-1">Track 1</button>
                    <button class="track-btn" id="track-2">Track 2</button>
                    <button class="track-btn" id="track-3">Track 3</button>
                </div>
            </div>
            
            <div class="status-text" id="audio-status">
                <i class="fas fa-check-circle"></i> Audio Ready
            </div>
        </div>
    </div>

    <!-- Animated Background -->
    <div class="bg-animation" id="bg-animation"></div>

    <!-- AUDIO ELEMENTS -->
    <audio id="bg-music-1" loop preload="auto">
        <source src="assets/sounds/bg-music-1.mp3" type="audio/mpeg">
    </audio>
    <audio id="bg-music-2" loop preload="auto">
        <source src="assets/sounds/bg-music-2.mp3" type="audio/mpeg">
    </audio>
    <audio id="bg-music-3" loop preload="auto">
        <source src="assets/sounds/bg-music-3.mp3" type="audio/mpeg">
    </audio>

    <!-- Sound Effects -->
    <audio id="sfx-correct" preload="auto">
        <source src="assets/sounds/correct.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-wrong" preload="auto">
        <source src="assets/sounds/wrong.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-levelup" preload="auto">
        <source src="assets/sounds/levelup.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-click" preload="auto">
        <source src="assets/sounds/click.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-monster" preload="auto">
        <source src="assets/sounds/monster.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-sword" preload="auto">
        <source src="assets/sounds/sword.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-damage" preload="auto">
        <source src="assets/sounds/damage.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-combo" preload="auto">
        <source src="assets/sounds/combo.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-win" preload="auto">
        <source src="assets/sounds/win.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-hero" preload="auto">
        <source src="assets/sounds/hero.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-coin" preload="auto">
        <source src="assets/sounds/coin.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-gameover" preload="auto">
        <source src="assets/sounds/gameover.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-timewarning" preload="auto">
        <source src="assets/sounds/timewarning.mp3" type="audio/mpeg">
    </audio>

    <div class="container">
        <!-- START SCREEN -->
        <div id="start-screen" class="screen active">
            <div class="game-logo">
                <h1>MATHQUESTADVENTURE</h1>
                <p class="game-tagline">Epic Math Battles</p>
                <p class="game-subtitle">Answer questions, defeat monsters, and become a math hero!</p>
            </div>

            <!-- Character Selection -->
            <div class="character-selection-pro">
                <h2 class="section-title">
                    <i class="fas fa-user-astronaut"></i>
                    SELECT YOUR MATH HERO
                </h2>
                
                <div class="characters-pro">
                    <div class="char-card selected" data-char="wizard">
                        <div class="char-icon-pro"><i class="fas fa-hat-wizard"></i></div>
                        <h3 class="char-name">Math Wizard</h3>
                        <p class="char-desc">Add 10 seconds to timer</p>
                        <div class="char-bonuses"><span class="bonus-tag">+10 Seconds (1/level)</span></div>
                    </div>
                    <div class="char-card" data-char="knight">
                        <div class="char-icon-pro"><i class="fas fa-chess-knight"></i></div>
                        <h3 class="char-name">Number Knight</h3>
                        <p class="char-desc">Extra health and heal</p>
                        <div class="char-bonuses"><span class="bonus-tag">+10% Life & Heal</span></div>
                    </div>
                    <div class="char-card" data-char="explorer">
                        <div class="char-icon-pro"><i class="fas fa-hiking"></i></div>
                        <h3 class="char-name">Equation Explorer</h3>
                        <p class="char-desc">More gold and double coins</p>
                        <div class="char-bonuses"><span class="bonus-tag">+10% Gold & Double</span></div>
                    </div>
                </div>
            </div>

            <!-- Pet Selection -->
            <div class="character-selection-pro">
                <h2 class="section-title">
                    <i class="fas fa-paw"></i> PICK YOUR PET FRIEND!
                </h2>
                
                <div class="characters-pro" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="char-card" data-pet="dragon">
                        <div class="char-icon-pro" style="color: #DC143C;"><i class="fas fa-dragon"></i></div>
                        <h3 class="char-name">Baby Dragon</h3>
                        <p class="char-desc">10% chance double points</p>
                        <span class="bonus-tag"> Fire Power!</span>
                    </div>
                    <div class="char-card" data-pet="fairy">
                        <div class="char-icon-pro" style="color: #FF69B4;"><i class="fas fa-star"></i></div>
                        <h3 class="char-name">Math Fairy</h3>
                        <p class="char-desc">10% chance heal 5 HP</p>
                        <span class="bonus-tag"> Healing Magic!</span>
                    </div>
                    <div class="char-card" data-pet="phoenix">
                        <div class="char-icon-pro" style="color: #FF4500;"><i class="fas fa-fire"></i></div>
                        <h3 class="char-name">Fire Phoenix</h3>
                        <p class="char-desc">Survive fatal damage once</p>
                        <span class="bonus-tag"> Second Chance!</span>
                    </div>
                    <div class="char-card" data-pet="turtle">
                        <div class="char-icon-pro" style="color: #2E8B57;"><i class="fas fa-shield-alt"></i></div>
                        <h3 class="char-name">Wise Turtle</h3>
                        <p class="char-desc">Reduces wrong answer damage</p>
                        <span class="bonus-tag"> Shield Up!</span>
                    </div>
                    <div class="char-card" data-pet="rabbit">
                        <div class="char-icon-pro" style="color: #FFB6C1;"><i class="fas fa-clock"></i></div>
                        <h3 class="char-name">Math Rabbit</h3>
                        <p class="char-desc">+2 seconds on correct</p>
                        <span class="bonus-tag"> Time Keeper!</span>
                    </div>
                </div>
            </div>

            <!-- Difficulty Selection -->
            <div class="difficulty-pro">
                <h2 class="section-title">
                    <i class="fas fa-chart-line"></i>
                    SELECT CHALLENGE LEVEL
                </h2>
                
                <div class="difficulty-buttons">
                    <button class="diff-btn-pro active" data-diff="easy">
                        <i class="fas fa-seedling diff-icon"></i>
                        BEGINNER
                        <small>Addition & Subtraction</small>
                    </button>
                    <button class="diff-btn-pro" data-diff="medium">
                        <i class="fas fa-tree diff-icon"></i>
                        INTERMEDIATE
                        <small>Multiplication & Division</small>
                    </button>
                    <button class="diff-btn-pro" data-diff="hard">
                        <i class="fas fa-mountain diff-icon"></i>
                        ADVANCED
                        <small>Mixed Operations</small>
                    </button>
                    <button class="diff-btn-pro" data-diff="expert">
                        <i class="fas fa-brain diff-icon"></i>
                        EXPERT
                        <small>Complex Problems</small>
                    </button>
                </div>
            </div>

            <!-- Game Stats -->
            <div class="stats-pro">
                <div class="stat-card-pro">
                    <i class="fas fa-flag-checkered stat-icon"></i>
                    <h3>Max Levels</h3>
                    <div class="stat-value">10</div>
                </div>
                <div class="stat-card-pro">
                    <i class="fas fa-trophy stat-icon"></i>
                    <h3>Achievements</h3>
                    <div class="stat-value">25</div>
                </div>
            </div>

            <!-- Achievements Display -->
            <div class="character-selection-pro" style="max-width: 800px;">
                <h2 class="section-title"><i class="fas fa-trophy"></i> YOUR ACHIEVEMENTS</h2>
                <div class="achievements-grid" id="achievements-container"></div>
            </div>

            <!-- GLOBAL LEADERBOARD -->
            <div class="character-selection-pro" style="max-width: 800px;">
                <h2 class="section-title">
                    <i class="fas fa-globe"></i> GLOBAL LEADERBOARD 
                    <span style="font-size: 1rem; background: var(--success); padding: 5px 15px; border-radius: 20px; margin-left: 10px;">LOCAL</span>
                </h2>
                <div class="high-score-tabs">
                    <button class="high-score-tab active" data-diff="easy">EASY</button>
                    <button class="high-score-tab" data-diff="medium">MEDIUM</button>
                    <button class="high-score-tab" data-diff="hard">HARD</button>
                    <button class="high-score-tab" data-diff="expert">EXPERT</button>
                </div>
                <div id="global-leaderboard-list" style="min-height: 100px;"></div>
                <div style="text-align: center; margin-top: 20px; color: rgba(255,255,255,0.5); font-size: 0.9rem;">
                    <i class="fas fa-save"></i> Data saved in localStorage!
                </div>
            </div>

            <!-- Daily Reward -->
            <div style="text-align: center;">
                <button id="daily-reward-btn" class="btn-premium" style="background: linear-gradient(145deg, var(--warning), #ff8c00);">
                    <i class="fas fa-gift"></i> CLAIM DAILY REWARD
                </button>
                <div id="reward-timer" style="color: rgba(255, 255, 255, 0.7); margin-top: 10px;"></div>
            </div>

            <!-- Statistics Button -->
            <div style="text-align: center;">
                <button id="stats-btn" class="btn-outline">
                    <i class="fas fa-chart-bar"></i> VIEW STATISTICS
                </button>
            </div>

            <!-- Music Selection -->
            <div style="text-align: center; margin: 30px 0;">
                <div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; display: inline-block;">
                    <h3 style="color: var(--accent);"><i class="fas fa-music"></i> QUICK MUSIC SELECT</h3>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button id="quick-music-1" class="btn-outline">Track 1</button>
                        <button id="quick-music-2" class="btn-outline">Track 2</button>
                        <button id="quick-music-3" class="btn-outline">Track 3</button>
                    </div>
                </div>
            </div>

            <!-- Shop Button -->
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin: 30px 0;">
                <button id="shop-menu-btn" class="btn-outline">
                    <i class="fas fa-store"></i> SHOP
                </button>
                <button id="badges-menu-btn" class="btn-outline">
                    <i class="fas fa-medal"></i> BADGES
                </button>
            </div>

            <!-- Start Button -->
            <div style="text-align: center;">
                <button id="enter-game-btn" class="btn-premium">
                    <i class="fas fa-rocket"></i> START ADVENTURE
                </button>
            </div>

            <!-- How to Play -->
            <div style="text-align: center;">
                <button id="how-to-play" class="btn-outline">
                    <i class="fas fa-question-circle"></i> How to Play
                </button>
            </div>
        </div>

        <!-- NAME ENTRY SCREEN -->
        <div id="name-entry-screen" class="screen">
            <div class="character-selection-pro" style="max-width: 600px; margin: 100px auto;">
                <h2 class="section-title"><i class="fas fa-user"></i> ENTER YOUR NAME</h2>
                <p style="text-align: center; margin: 20px 0 40px;">Your name will be saved in GLOBAL leaderboard!</p>
                <input type="text" id="player-name" class="name-input" placeholder="Enter your name here..." maxlength="20" autocomplete="off">
                <div style="display: flex; gap: 20px; justify-content: center;">
                    <button id="confirm-name-btn" class="btn-premium" style="padding: 15px 40px;">
                        <i class="fas fa-check-circle"></i> START ADVENTURE
                    </button>
                    <button id="back-to-menu-btn" class="btn-outline" style="padding: 15px 40px;">
                        <i class="fas fa-arrow-left"></i> BACK
                    </button>
                </div>
            </div>
        </div>

        <!-- HOW TO PLAY SCREEN -->
        <div id="how-to-play-screen" class="screen">
            <div class="character-selection-pro" style="max-width: 1000px; margin: 50px auto;">
                <h2 class="section-title"><i class="fas fa-question-circle"></i> HOW TO PLAY</h2>
                <div class="options-grid-pro" style="grid-template-columns: repeat(2,1fr);">
                    <div style="background:rgba(255,255,255,0.05); border-radius:20px; padding:30px;">
                        <h3 style="color:var(--accent);"> Game Rules</h3>
                        <ul style="list-style:none;">
                            <li><i class="fas fa-check-circle" style="color:#4caf50; margin-right:10px;"></i>Enter your name</li>
                            <li><i class="fas fa-check-circle" style="color:#4caf50; margin-right:10px;"></i>Choose hero & pet</li>
                            <li><i class="fas fa-check-circle" style="color:#4caf50; margin-right:10px;"></i>Pick difficulty</li>
                            <li><i class="fas fa-check-circle" style="color:#4caf50; margin-right:10px;"></i>Answer to defeat monsters</li>
                            <li><i class="fas fa-check-circle" style="color:#4caf50; margin-right:10px;"></i>Beat 5 monsters per level</li>
                            <li><i class="fas fa-check-circle" style="color:#4caf50; margin-right:10px;"></i>Complete 10 levels to win!</li>
                        </ul>
                    </div>
                    <div style="background:rgba(255,255,255,0.05); border-radius:20px; padding:30px;">
                        <h3 style="color:var(--accent);"> Hero Skills</h3>
                        <ul style="list-style:none;">
                            <li><i class="fas fa-hat-wizard" style="color:#f72585; margin-right:10px;"></i>Wizard: +10 seconds</li>
                            <li><i class="fas fa-chess-knight" style="color:#4361ee; margin-right:10px;"></i>Knight: Heal 30%</li>
                            <li><i class="fas fa-hiking" style="color:#ffd700; margin-right:10px;"></i>Explorer: Double coins</li>
                        </ul>
                    </div>
                    <div style="background:rgba(255,255,255,0.05); border-radius:20px; padding:30px;">
                        <h3 style="color:var(--accent);"> Pet Abilities</h3>
                        <ul style="list-style:none;">
                            <li><i class="fas fa-dragon" style="color:#DC143C;"></i> Dragon: Double points (10%)</li>
                            <li><i class="fas fa-star" style="color:#FF69B4;"></i> Fairy: Heal 5 HP (10%)</li>
                            <li><i class="fas fa-fire" style="color:#FF4500;"></i> Phoenix: Survive fatal</li>
                            <li><i class="fas fa-shield-alt" style="color:#2E8B57;"></i> Turtle: Reduce damage</li>
                            <li><i class="fas fa-clock" style="color:#FFB6C1;"></i> Rabbit: +2 seconds</li>
                        </ul>
                    </div>
                    <div style="background:rgba(255,255,255,0.05); border-radius:20px; padding:30px;">
                        <h3 style="color:var(--accent);"> Tips</h3>
                        <ul style="list-style:none;">
                            <li><i class="fas fa-lightbulb" style="color:#FFD93D;"></i> HINT: Remove 2 answers (50 coins)</li>
                            <li><i class="fas fa-redo-alt" style="color:#ff8c00;"></i> RETRY: Once per question (-8s)</li>
                            <li><i class="fas fa-forward" style="color:#9d4edd;"></i> SKIP: After retry (-5 HP)</li>
                            <li><i class="fas fa-clock" style="color:#4cc9f0;"></i> Time Freeze: +5 seconds (150 coins)</li>
                        </ul>
                    </div>
                </div>
                <div style="text-align:center; margin-top:40px;">
                    <button id="back-to-menu-howto" class="btn-outline">
                        <i class="fas fa-arrow-left"></i> BACK TO MENU
                    </button>
                </div>
            </div>
        </div>

        <!-- STATISTICS SCREEN -->
        <div id="stats-screen" class="screen">
            <div class="character-selection-pro" style="max-width: 800px; margin: 50px auto;">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> YOUR STATISTICS</h2>
                <div class="stats-grid-large">
                    <div class="stat-card-large">
                        <i class="fas fa-gamepad"></i>
                        <h3>Games Played</h3>
                        <div class="stat-value" id="stat-games">0</div>
                    </div>
                    <div class="stat-card-large">
                        <i class="fas fa-question-circle"></i>
                        <h3>Questions</h3>
                        <div class="stat-value" id="stat-questions">0</div>
                    </div>
                    <div class="stat-card-large">
                        <i class="fas fa-check-circle" style="color:#4caf50;"></i>
                        <h3>Correct</h3>
                        <div class="stat-value" id="stat-correct">0</div>
                    </div>
                    <div class="stat-card-large">
                        <i class="fas fa-times-circle" style="color:#ff6b6b;"></i>
                        <h3>Wrong</h3>
                        <div class="stat-value" id="stat-wrong">0</div>
                    </div>
                    <div class="stat-card-large">
                        <i class="fas fa-chart-line"></i>
                        <h3>Accuracy</h3>
                        <div class="stat-value" id="stat-accuracy">0%</div>
                    </div>
                    <div class="stat-card-large">
                        <i class="fas fa-dragon"></i>
                        <h3>Monsters</h3>
                        <div class="stat-value" id="stat-monsters">0</div>
                    </div>
                    <div class="stat-card-large">
                        <i class="fas fa-arrow-up"></i>
                        <h3>Max Level</h3>
                        <div class="stat-value" id="stat-maxlevel">1</div>
                    </div>
                    <div class="stat-card-large">
                        <i class="fas fa-clock"></i>
                        <h3>Play Time</h3>
                        <div class="stat-value" id="stat-time">0m</div>
                    </div>
                </div>
                <div style="text-align:center;">
                    <button id="back-to-menu-stats" class="btn-outline">
                        <i class="fas fa-arrow-left"></i> BACK TO MENU
                    </button>
                </div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <div class="game-header-pro">
                <div class="player-info-pro">
                    <div class="char-display"><i id="current-char-icon" class="fas fa-hat-wizard"></i></div>
                    <div class="player-stats-pro">
                        <div class="stat-badge"><i class="fas fa-layer-group"></i><div><div>LEVEL</div><div class="stat-value-pro" id="current-level">1</div></div></div>
                        <div class="stat-badge"><i class="fas fa-star"></i><div><div>SCORE</div><div class="stat-value-pro" id="current-score">0</div></div></div>
                        <div class="stat-badge"><i class="fas fa-coins"></i><div><div>COINS</div><div class="stat-value-pro" id="coins">500</div></div></div>
                        <div class="stat-badge"><i class="fas fa-bolt"></i><div><div>STREAK</div><div class="stat-value-pro" id="streak">0</div></div></div>
                        <div class="stat-badge" id="pet-display" style="display:none;"><i id="pet-icon" class="fas fa-paw"></i><div><div>PET</div><div class="stat-value-pro" id="pet-name">None</div></div></div>
                    </div>
                </div>
                <div class="game-controls-pro">
                    <div class="timer-pro"><div class="timer-value" id="timer">30</div><div>SECONDS</div></div>
                    <button id="pause-btn" class="btn-outline"><i class="fas fa-pause-circle"></i> PAUSE</button>
                </div>
            </div>

            <div class="battle-arena">
                <div class="combatants">
                    <div class="combatant enemy">
                        <div class="combatant-icon enemy-icon"><i class="fas fa-dragon"></i></div>
                        <div><div class="health-bar-pro"><div class="health-fill-pro" id="enemy-health" style="width:100%"></div></div><div>MONSTER HEALTH</div></div>
                    </div>
                    <div style="text-align:center; padding:0 40px;"><div style="background:linear-gradient(145deg,var(--primary),var(--secondary)); width:100px; height:100px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-family:'Orbitron'; font-size:1.5rem; font-weight:900; animation:vsPulse 2s infinite;">VS</div></div>
                    <div class="combatant hero">
                        <div class="combatant-icon hero-icon"><i id="hero-icon" class="fas fa-hat-wizard"></i></div>
                        <div><div class="health-bar-pro"><div class="health-fill-pro" id="hero-health" style="width:100%"></div></div><div>YOUR HEALTH</div></div>
                    </div>
                </div>

                <div class="question-area">
                    <div class="question-card">
                        <div class="compact-timer" id="compact-timer">
                            <i class="fas fa-hourglass-half"></i> <span id="compact-timer-value">30</span>s
                            <span id="retry-badge" class="retry-badge hidden">RETRY</span>
                            <span id="skip-badge" class="retry-badge hidden" style="border-color:var(--accent); color:var(--accent);">SKIP</span>
                        </div>
                        <div style="color:rgba(255,255,255,0.7);">DIFFICULTY: <span id="difficulty-label">BEGINNER</span></div>
                        <div id="question" style="min-height:120px;">5 + 3 = ?</div>
                        <div class="question-meta">
                            <div>LEVEL <span id="question-level">1</span></div>
                            <div>QUESTION <span id="question-number">1</span></div>
                        </div>
                    </div>
                </div>

                <div class="options-grid-pro" id="options-container"></div>

                <div class="feedback-pro">
                    <div id="feedback-text" class="feedback-message"></div>
                    <div style="display:flex; justify-content:center; gap:30px;">
                        <div style="color:#4caf50;">CORRECT: <span id="correct-count">0</span></div>
                        <div style="color:#ff6b6b;">WRONG: <span id="wrong-count">0</span></div>
                        <div style="color:var(--accent);">ACCURACY: <span id="accuracy">0%</span></div>
                    </div>
                </div>

                <div class="progress-tracker">
                    <div class="progress-info"><span>LEVEL PROGRESS</span><span id="progress-text">0/5 Monsters</span></div>
                    <div class="progress-bar-pro"><div class="progress-fill-pro" id="level-progress" style="width:0%"></div></div>
                </div>
            </div>

            <div style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap;">
                <button id="hint-btn" class="btn-outline"><i class="fas fa-lightbulb"></i> HINT (50)</button>
                <button id="hero-skill-btn" class="skill-btn"><i id="skill-icon" class="fas fa-hat-wizard"></i> <span id="skill-text">Use Skill</span></button>
                <button id="powerup-btn" class="btn-premium" style="padding:15px 30px;"><i class="fas fa-clock"></i> TIME FREEZE (150)</button>
                <button id="next-btn" class="btn-premium hidden" style="padding:15px 30px;"><i class="fas fa-forward"></i> NEXT</button>
                <button id="retry-btn" class="btn-premium hidden" style="padding:15px 30px; background:linear-gradient(145deg,#ff8c00,#ff6b00);"><i class="fas fa-redo-alt"></i> RETRY</button>
                <button id="skip-btn" class="btn-premium hidden" style="padding:15px 30px; background:linear-gradient(145deg,#9d4edd,#6a4c93);"><i class="fas fa-forward"></i> SKIP</button>
            </div>
        </div>

        <!-- PAUSE SCREEN -->
        <div id="pause-screen" class="screen">
            <div style="text-align:center; max-width:600px; margin:100px auto;">
                <h1 style="font-family:'Orbitron'; font-size:4rem;">GAME PAUSED</h1>
                <div style="background:rgba(255,255,255,0.05); backdrop-filter:blur(20px); border:1px solid var(--glass-border); border-radius:30px; padding:40px;">
                    <button id="resume-btn" class="btn-premium" style="width:100%; margin-bottom:20px;"><i class="fas fa-play-circle"></i> RESUME</button>
                    <button id="restart-btn" class="btn-outline" style="width:100%; margin-bottom:20px;"><i class="fas fa-redo"></i> RESTART LEVEL</button>
                    <button id="quit-btn" class="btn-outline" style="width:100%;"><i class="fas fa-home"></i> MAIN MENU</button>
                </div>
            </div>
        </div>

        <!-- LEVEL COMPLETE SCREEN -->
        <div id="level-complete-screen" class="screen">
            <div class="character-selection-pro" style="max-width:800px; margin:100px auto;">
                <div style="text-align:center;">
                    <i class="fas fa-trophy" style="font-size:6rem; color:var(--warning);"></i>
                    <h2 style="font-family:'Orbitron'; font-size:3rem; color:var(--accent);">LEVEL COMPLETE!</h2>
                    <div class="options-grid-pro" style="grid-template-columns:repeat(3,1fr); max-width:600px; margin:0 auto 40px;">
                        <div><div>SCORE</div><div style="font-size:2rem; color:var(--accent);" id="level-complete-score">0</div></div>
                        <div><div>COINS</div><div style="font-size:2rem; color:var(--warning);" id="level-complete-coins">0</div></div>
                        <div><div>ACCURACY</div><div style="font-size:2rem; color:#4caf50;" id="level-complete-accuracy">0%</div></div>
                    </div>
                    <button id="continue-btn" class="btn-premium"><i class="fas fa-arrow-right"></i> NEXT LEVEL!</button>
                </div>
            </div>
        </div>

        <!-- GAME OVER SCREEN -->
        <div id="game-over-screen" class="screen">
            <div class="character-selection-pro" style="max-width:800px; margin:100px auto;">
                <div style="text-align:center;">
                    <i class="fas fa-skull" style="font-size:6rem; color:var(--danger);"></i>
                    <h2 style="font-family:'Orbitron'; font-size:3rem; color:var(--danger);">GAME OVER</h2>
                    <div class="options-grid-pro" style="grid-template-columns:repeat(3,1fr); max-width:600px; margin:0 auto 40px;">
                        <div><div>FINAL SCORE</div><div style="font-size:2rem; color:var(--accent);" id="game-over-score">0</div></div>
                        <div><div>LEVEL</div><div style="font-size:2rem; color:var(--warning);" id="game-over-level">1</div></div>
                        <div><div>COINS</div><div style="font-size:2rem; color:#4caf50;" id="game-over-coins">0</div></div>
                    </div>
                    <button id="game-over-menu-btn" class="btn-premium"><i class="fas fa-home"></i> BACK TO MENU</button>
                </div>
            </div>
        </div>

        <!-- CONGRATULATIONS SCREEN -->
        <div id="congratulations-screen" class="screen">
            <div class="character-selection-pro" style="max-width:800px; margin:100px auto;">
                <div style="text-align:center;">
                    <i class="fas fa-crown" style="font-size:6rem; color:var(--warning);"></i>
                    <h2 style="font-family:'Orbitron'; font-size:3rem; color:var(--accent);">YOU'RE A MATH HERO!</h2>
                    <p style="margin-bottom:40px;">You completed all 10 levels! </p>
                    <div class="options-grid-pro" style="grid-template-columns:repeat(3,1fr); max-width:600px; margin:0 auto 40px;">
                        <div><div>FINAL SCORE</div><div style="font-size:2rem; color:var(--accent);" id="congrats-score">0</div></div>
                        <div><div>TOTAL COINS</div><div style="font-size:2rem; color:var(--warning);" id="congrats-coins">0</div></div>
                        <div><div>ACCURACY</div><div style="font-size:2rem; color:#4caf50;" id="congrats-accuracy">0%</div></div>
                    </div>
                    <button id="congrats-menu-btn" class="btn-premium"><i class="fas fa-home"></i> PLAY AGAIN</button>
                </div>
            </div>
        </div>

        <!-- SHOP SCREEN -->
        <div id="shop-screen" class="screen">
            <div class="character-selection-pro" style="max-width: 1000px; margin: 50px auto;">
                <h2 class="section-title">
                    <i class="fas fa-store"></i>
                    ITEM SHOP
                </h2>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div class="stat-badge">
                        <i class="fas fa-coins"></i>
                        <div>
                            <div>YOUR COINS</div>
                            <div class="stat-value-pro" id="shop-coins">500</div>
                        </div>
                    </div>
                    <button id="back-from-shop" class="btn-outline">
                        <i class="fas fa-arrow-left"></i> BACK
                    </button>
                </div>

                <div class="shop-grid" id="shop-items"></div>
            </div>
        </div>

        <!-- BADGES SCREEN -->
        <div id="badges-screen" class="screen">
            <div class="character-selection-pro" style="max-width: 900px; margin: 50px auto;">
                <h2 class="section-title">
                    <i class="fas fa-medal"></i>
                    ACHIEVEMENT BADGES
                </h2>

                <div class="badge-container" id="badges-container"></div>

                <div style="text-align: center; margin-top: 30px;">
                    <button id="back-from-badges" class="btn-outline">
                        <i class="fas fa-arrow-left"></i> BACK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== AUDIO SYSTEM =====
        class AudioSystem {
            constructor() {
                this.bgMusic = [
                    document.getElementById('bg-music-1'),
                    document.getElementById('bg-music-2'),
                    document.getElementById('bg-music-3')
                ];
                
                this.sfx = {
                    correct: document.getElementById('sfx-correct'),
                    wrong: document.getElementById('sfx-wrong'),
                    levelup: document.getElementById('sfx-levelup'),
                    click: document.getElementById('sfx-click'),
                    monster: document.getElementById('sfx-monster'),
                    sword: document.getElementById('sfx-sword'),
                    damage: document.getElementById('sfx-damage'),
                    combo: document.getElementById('sfx-combo'),
                    win: document.getElementById('sfx-win'),
                    hero: document.getElementById('sfx-hero'),
                    coin: document.getElementById('sfx-coin'),
                    gameover: document.getElementById('sfx-gameover'),
                    timewarning: document.getElementById('sfx-timewarning')
                };
                
                this.musicEnabled = true;
                this.sfxEnabled = true;
                this.musicVolume = 0.5;
                this.sfxVolume = 0.7;
                this.currentTrack = 0;
                this.audioInitialized = false;
                
                this.init();
            }
            
            init() {
                this.bgMusic.forEach(track => {
                    if (track) track.volume = this.musicVolume;
                });
                
                Object.values(this.sfx).forEach(sfx => {
                    if (sfx) sfx.volume = this.sfxVolume;
                });
                
                this.setupEventListeners();
                
                const startAudio = () => {
                    if (!this.audioInitialized) {
                        this.audioInitialized = true;
                        document.getElementById('audio-status').innerHTML = '<i class="fas fa-check-circle"></i> Audio Ready';
                        if (this.musicEnabled) {
                            this.playMusic();
                        }
                    }
                };
                
                document.addEventListener('click', startAudio, { once: true });
                document.addEventListener('touchstart', startAudio, { once: true });
                
                document.getElementById('audio-status').innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Click to enable audio';
            }
            
            setupEventListeners() {
                document.getElementById('music-toggle-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.musicEnabled = !this.musicEnabled;
                    const btn = e.currentTarget;
                    
                    if (this.musicEnabled) {
                        btn.innerHTML = '<i class="fas fa-music"></i>';
                        btn.classList.remove('muted');
                        this.playMusic();
                    } else {
                        btn.innerHTML = '<i class="fas fa-music"></i>';
                        btn.classList.add('muted');
                        this.bgMusic.forEach(track => {
                            if (track) track.pause();
                        });
                    }
                    this.playSFX('click');
                });
                
                document.getElementById('sfx-toggle-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.sfxEnabled = !this.sfxEnabled;
                    const btn = e.currentTarget;
                    
                    if (this.sfxEnabled) {
                        btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                        btn.classList.remove('muted');
                    } else {
                        btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                        btn.classList.add('muted');
                    }
                    this.playSFX('click');
                });
                
                const volumeBtn = document.getElementById('volume-btn');
                const volumeControl = document.getElementById('volume-control');
                
                volumeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    volumeControl.classList.toggle('show');
                });
                
                const musicSlider = document.getElementById('music-volume-slider');
                musicSlider.addEventListener('input', (e) => {
                    this.musicVolume = e.target.value / 100;
                    this.bgMusic.forEach(track => {
                        if (track) track.volume = this.musicVolume;
                    });
                    document.getElementById('music-vol-value').textContent = e.target.value + '%';
                });
                
                const sfxSlider = document.getElementById('sfx-volume-slider');
                sfxSlider.addEventListener('input', (e) => {
                    this.sfxVolume = e.target.value / 100;
                    Object.values(this.sfx).forEach(sfx => {
                        if (sfx) sfx.volume = this.sfxVolume;
                    });
                    document.getElementById('sfx-vol-value').textContent = e.target.value + '%';
                });
                
                document.getElementById('track-1').addEventListener('click', () => this.selectTrack(0));
                document.getElementById('track-2').addEventListener('click', () => this.selectTrack(1));
                document.getElementById('track-3').addEventListener('click', () => this.selectTrack(2));
                
                document.getElementById('quick-music-1')?.addEventListener('click', () => this.selectTrack(0));
                document.getElementById('quick-music-2')?.addEventListener('click', () => this.selectTrack(1));
                document.getElementById('quick-music-3')?.addEventListener('click', () => this.selectTrack(2));
                
                document.addEventListener('click', (e) => {
                    if (!volumeControl.contains(e.target) && !volumeBtn.contains(e.target)) {
                        volumeControl.classList.remove('show');
                    }
                });
            }
            
            selectTrack(index) {
                document.querySelectorAll('.track-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`track-${index+1}`).classList.add('active');
                
                if (document.getElementById('quick-music-1')) {
                    document.querySelectorAll('[id^="quick-music-"]').forEach(btn => btn.classList.remove('active'));
                    document.getElementById(`quick-music-${index+1}`)?.classList.add('active');
                }
                
                if (this.bgMusic[this.currentTrack]) {
                    this.bgMusic[this.currentTrack].pause();
                    this.bgMusic[this.currentTrack].currentTime = 0;
                }
                
                this.currentTrack = index;
                
                if (this.musicEnabled && this.audioInitialized) {
                    this.playMusic();
                }
                
                this.playSFX('click');
            }
            
            playMusic() {
                if (!this.musicEnabled || !this.audioInitialized) return;
                
                this.bgMusic.forEach(track => {
                    if (track) {
                        track.pause();
                        track.currentTime = 0;
                    }
                });
                
                if (this.bgMusic[this.currentTrack]) {
                    this.bgMusic[this.currentTrack].play().catch(e => {});
                }
            }
            
            playSFX(soundName) {
                if (!this.sfxEnabled || !this.audioInitialized) return;
                
                try {
                    const sfx = this.sfx[soundName];
                    if (sfx) {
                        sfx.currentTime = 0;
                        sfx.play().catch(e => {});
                    }
                } catch (e) {}
            }
            
            stopMusic() {
                this.bgMusic.forEach(track => {
                    if (track) {
                        track.pause();
                        track.currentTime = 0;
                    }
                });
            }
        }

        // ===== MATHQUESTADVENTURE GAME =====
        class MathQuestAdventure {
            constructor() {
                this.state = {
                    playerName: localStorage.getItem('mathQuestPlayerName') || '',
                    score: 0,
                    coins: 500,
                    level: 1,
                    maxLevel: 10,
                    currentCharacter: 'wizard',
                    difficulty: 'easy',
                    timeLeft: 30,
                    timer: null,
                    isPaused: false,
                    isGameActive: false,
                    heroHealth: 100,
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    currentQuestion: null,
                    usedQuestions: [],
                    currentQuestionWrongAttempts: 0,
                    retryUsedForCurrent: false,
                    
                    shop: {
                        items: [
                            { id: 'health_potion', name: 'Health Potion', desc: 'Restore 25 HP', price: 50, icon: 'fa-heart', type: 'consumable', effect: 'heal' },
                            { id: 'time_freeze', name: 'Time Freeze', desc: '+15 seconds', price: 100, icon: 'fa-clock', type: 'consumable', effect: 'time' },
                            { id: 'shield', name: 'Magic Shield', desc: 'Block 1 wrong answer', price: 75, icon: 'fa-shield-alt', type: 'consumable', effect: 'shield' },
                            { id: 'double_points', name: 'Double Points', desc: '2x score for 3 questions', price: 150, icon: 'fa-star', type: 'consumable', effect: 'double' },
                            { id: 'super_heal', name: 'Super Heal', desc: 'Full HP restore', price: 200, icon: 'fa-heartbeat', type: 'consumable', effect: 'fullheal' },
                            { id: 'extra_time', name: 'Extra Time', desc: '+30 seconds', price: 250, icon: 'fa-hourglass', type: 'consumable', effect: 'extratime' }
                        ],
                        inventory: JSON.parse(localStorage.getItem('mathQuestInventory')) || []
                    },
                    
                    combo: {
                        count: 0,
                        multiplier: 1.0,
                        timer: null,
                        timeLeft: 5,
                        active: false
                    },
                    
                    badges: {
                        novice: { name: 'Math Novice', desc: 'Complete 10 questions', icon: 'fa-seedling', earned: false, level: 1 },
                        warrior: { name: 'Math Warrior', desc: 'Defeat 20 monsters', icon: 'fa-shield', earned: false, level: 2 },
                        master: { name: 'Math Master', desc: 'Reach level 5', icon: 'fa-crown', earned: false, level: 3 },
                        legend: { name: 'Math Legend', desc: 'Score 5000 points', icon: 'fa-star', earned: false, level: 4 },
                        god: { name: 'Math God', desc: 'Complete all levels', icon: 'fa-dragon', earned: false, level: 5 }
                    },
                    
                    monstersDefeated: 0,
                    monstersPerLevel: 5,
                    streak: 0,
                    currentMonsterHealth: 100,
                    waitForNext: false,
                    skillUsed: false,
                    explorerDoubleCoins: false,
                    hintUsed: false,
                    
                    achievements: {
                        wizard_master: { earned: false, name: "Wizard Master", desc: "Complete level as Wizard" },
                        knight_defender: { earned: false, name: "Knight Defender", desc: "Complete level as Knight" },
                        explorer_rich: { earned: false, name: "Golden Explorer", desc: "Complete level as Explorer" },
                        first_blood: { earned: false, name: "First Blood", desc: "Defeat your first monster" },
                        streak_master: { earned: false, name: "Streak Master", desc: "5 correct in a row" },
                        perfect_level: { earned: false, name: "Perfect Level", desc: "Complete level with full health" },
                        high_roller: { earned: false, name: "High Roller", desc: "Score 1000+ points" },
                        coin_collector: { earned: false, name: "Coin Collector", desc: "Collect 500+ coins" },
                        hot_streak: { earned: false, name: "Hot Streak", desc: "10 correct in a row" },
                        invincible: { earned: false, name: "Invincible", desc: "Reach level 5+" }
                    },
                    
                    dailyReward: {
                        lastClaimed: localStorage.getItem('mathQuestLastReward'),
                        streak: parseInt(localStorage.getItem('mathQuestRewardStreak')) || 0,
                        available: false
                    },
                    
                    pet: {
                        type: localStorage.getItem('mathQuestPet') || null,
                        dragonCritical: false,
                        fairyHeal: false,
                        phoenixRevive: true
                    },
                    
                    stats: {
                        gamesPlayed: parseInt(localStorage.getItem('mathQuestGames')) || 0,
                        totalQuestions: parseInt(localStorage.getItem('mathQuestQuestions')) || 0,
                        correctAnswers: parseInt(localStorage.getItem('mathQuestCorrect')) || 0,
                        wrongAnswers: parseInt(localStorage.getItem('mathQuestWrong')) || 0,
                        monstersDefeated: parseInt(localStorage.getItem('mathQuestMonsters')) || 0,
                        maxLevel: parseInt(localStorage.getItem('mathQuestMaxLevel')) || 1,
                        playTime: parseInt(localStorage.getItem('mathQuestPlayTime')) || 0,
                        totalCoins: parseInt(localStorage.getItem('mathQuestTotalCoins')) || 0,
                        maxStreak: parseInt(localStorage.getItem('mathQuestMaxStreak')) || 0,
                        fastAnswers: parseInt(localStorage.getItem('mathQuestFastAnswers')) || 0
                    },
                    
                    powerups: {
                        shieldActive: false,
                        doublePointsActive: false,
                        doublePointsRemaining: 0
                    },
                    
                    // Animation state for smooth transitions
                    animationFrame: null,
                    lastTime: 0
                };

                this.audio = new AudioSystem();
                
                this.pets = {
                    dragon: { name: "Baby Dragon", color: "#DC143C" },
                    fairy: { name: "Math Fairy", color: "#FF69B4" },
                    phoenix: { name: "Fire Phoenix", color: "#FF4500" },
                    turtle: { name: "Wise Turtle", color: "#2E8B57" },
                    rabbit: { name: "Math Rabbit", color: "#FFB6C1" }
                };
                
                this.skills = {
                    wizard: { name: "Time Boost", icon: "fas fa-clock", effect: () => this.wizardSkill() },
                    knight: { name: "Life Boost", icon: "fas fa-shield-alt", effect: () => this.knightSkill() },
                    explorer: { name: "Gold Rush", icon: "fas fa-coins", effect: () => this.explorerSkill() }
                };
                
                this.init();
            }

            init() {
                this.createAnimatedBackground();
                this.loadAchievements();
                this.setupEventListeners();
                this.checkDailyReward();
                this.updatePetDisplay();
                this.initPetSelection();
                this.updateSkillButton();
                this.updateStatisticsDisplay();
                this.initShop();
                this.initBadges();
                this.startComboTimer();
                
                this.loadGlobalLeaderboard('easy');
                
                setInterval(() => this.checkDailyReward(), 60000);
                
                // Start smooth animation loop
                this.startAnimationLoop();
            }

            startAnimationLoop() {
                const animate = (currentTime) => {
                    if (this.state.isGameActive) {
                        // Smooth animations for health bars and progress
                        this.smoothUIUpdates();
                    }
                    requestAnimationFrame(animate);
                };
                requestAnimationFrame(animate);
            }

            smoothUIUpdates() {
                // Smooth health bar transitions
                const enemyHealth = document.getElementById('enemy-health');
                const heroHealth = document.getElementById('hero-health');
                const progressBar = document.getElementById('level-progress');
                
                if (enemyHealth) {
                    enemyHealth.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                }
                if (heroHealth) {
                    heroHealth.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                }
                if (progressBar) {
                    progressBar.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                }
            }

            createAnimatedBackground() {
                const bg = document.getElementById('bg-animation');
                for (let i = 0; i < 30; i++) {
                    const p = document.createElement('div');
                    p.className = 'bg-particle';
                    const s = Math.random() * 200 + 50;
                    p.style.cssText = `width:${s}px; height:${s}px; left:${Math.random()*100}%; opacity:${Math.random()*0.1}; animation-duration:${Math.random()*20+20}s; animation-delay:${Math.random()*20}s;`;
                    bg.appendChild(p);
                }
            }

            setupEventListeners() {
                // Character selection
                document.querySelectorAll('.char-card[data-char]').forEach(c => {
                    c.addEventListener('click', () => {
                        document.querySelectorAll('.char-card[data-char]').forEach(c2 => c2.classList.remove('selected'));
                        c.classList.add('selected');
                        this.state.currentCharacter = c.dataset.char;
                        this.updateCharacterIcons();
                        this.updateSkillButton();
                        this.audio.playSFX('click');
                    });
                });

                // PET SELECTION - ONLY click sound, NO levelup
                document.querySelectorAll('.char-card[data-pet]').forEach(c => {
                    c.addEventListener('click', () => {
                        // ONLY play click sound
                        this.audio.playSFX('click');
                        
                        document.querySelectorAll('.char-card[data-pet]').forEach(c2 => c2.classList.remove('selected'));
                        c.classList.add('selected');
                        this.state.pet.type = c.dataset.pet;
                        localStorage.setItem('mathQuestPet', this.state.pet.type);
                        this.updatePetDisplay();
                        
                        this.showToast(` You adopted a ${this.pets[this.state.pet.type].name}!`);
                    });
                });

                // Difficulty selection
                document.querySelectorAll('.diff-btn-pro').forEach(b => {
                    b.addEventListener('click', () => {
                        document.querySelectorAll('.diff-btn-pro').forEach(b2 => b2.classList.remove('active'));
                        b.classList.add('active');
                        this.state.difficulty = b.dataset.diff;
                        this.audio.playSFX('click');
                    });
                });

                // Global leaderboard tabs
                document.querySelectorAll('.high-score-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.high-score-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.loadGlobalLeaderboard(tab.dataset.diff);
                        this.audio.playSFX('click');
                    });
                });

                // Main menu buttons
                document.getElementById('enter-game-btn').addEventListener('click', () => this.showNameEntry());
                document.getElementById('confirm-name-btn').addEventListener('click', () => this.startGame());
                document.getElementById('back-to-menu-btn').addEventListener('click', () => this.switchScreen('start'));
                document.getElementById('back-to-menu-howto').addEventListener('click', () => this.switchScreen('start'));
                document.getElementById('back-to-menu-stats').addEventListener('click', () => this.switchScreen('start'));
                document.getElementById('pause-btn').addEventListener('click', () => this.pauseGame());
                document.getElementById('resume-btn').addEventListener('click', () => this.resumeGame());
                document.getElementById('restart-btn').addEventListener('click', () => this.restartLevel());
                document.getElementById('quit-btn').addEventListener('click', () => this.quitToMenu());
                document.getElementById('next-btn').addEventListener('click', () => this.nextQuestion());
                document.getElementById('retry-btn').addEventListener('click', () => this.retryQuestion());
                document.getElementById('skip-btn').addEventListener('click', () => this.skipQuestion());
                document.getElementById('hint-btn').addEventListener('click', () => this.showHint());
                document.getElementById('powerup-btn').addEventListener('click', () => this.usePowerup());
                document.getElementById('hero-skill-btn').addEventListener('click', () => this.useHeroSkill());
                document.getElementById('how-to-play').addEventListener('click', () => this.showHowToPlay());
                document.getElementById('daily-reward-btn').addEventListener('click', () => this.claimDailyReward());
                document.getElementById('continue-btn').addEventListener('click', () => this.continueToNextLevel());
                document.getElementById('game-over-menu-btn').addEventListener('click', () => this.quitToMenu());
                document.getElementById('congrats-menu-btn').addEventListener('click', () => this.quitToMenu());
                document.getElementById('stats-btn').addEventListener('click', () => this.showStatistics());

                // Shop
                document.getElementById('shop-menu-btn').addEventListener('click', () => {
                    this.updateShopDisplay();
                    this.switchScreen('shop');
                });
                
                document.getElementById('back-from-shop').addEventListener('click', () => {
                    this.switchScreen('start');
                });
                
                // Badges
                document.getElementById('badges-menu-btn').addEventListener('click', () => {
                    this.updateBadgesDisplay();
                    this.switchScreen('badges');
                });
                
                document.getElementById('back-from-badges').addEventListener('click', () => {
                    this.switchScreen('start');
                });
            }

            // ===== TOAST NOTIFICATIONS =====
            showToast(message, duration = 3000) {
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.textContent = message;
                document.getElementById('toast-container').appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'toastSlide 0.3s ease reverse';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            // ===== CELEBRATION ANIMATIONS =====
            showLevel10Celebration() {
                const container = document.getElementById('celebration-container');
                container.classList.add('active');
                
                // Create celebration text
                const celebrationText = document.createElement('div');
                celebrationText.className = 'celebration-text';
                celebrationText.style.background = 'linear-gradient(45deg, var(--warning), var(--accent), var(--primary))';
                celebrationText.style.webkitBackgroundClip = 'text';
                celebrationText.style.backgroundClip = 'text';
                celebrationText.style.color = 'transparent';
                celebrationText.innerHTML = ' YOU ARE A MATH HERO! <br><span style="font-size: 3rem;"> CHAMPION </span>';
                container.appendChild(celebrationText);
                
                // Create fireworks
                for (let i = 0; i < 30; i++) {
                    setTimeout(() => {
                        this.createFirework();
                    }, i * 100);
                }
                
                // Create star rain
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        this.createStar();
                    }, i * 50);
                }
                
                // Remove celebration after 5 seconds
                setTimeout(() => {
                    container.classList.remove('active');
                    container.innerHTML = '<div class="star-rain" id="star-rain"></div>';
                }, 5000);
            }

            createFirework() {
                const firework = document.createElement('div');
                firework.className = 'firework';
                
                const colors = ['#f72585', '#4361ee', '#4cc9f0', '#ff6b6b', '#ffd700', '#4caf50', '#9d4edd'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                const x = (Math.random() - 0.5) * 200;
                const y = (Math.random() - 0.5) * 200;
                
                firework.style.cssText = `
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                    background: ${color};
                    box-shadow: 0 0 20px ${color};
                    --x: ${x}px;
                    --y: ${y}px;
                `;
                
                document.getElementById('celebration-container').appendChild(firework);
                setTimeout(() => firework.remove(), 1500);
            }

            createStar() {
                const star = document.createElement('div');
                star.className = 'star';
                
                const stars = ['', '', '', ''];
                star.innerHTML = stars[Math.floor(Math.random() * stars.length)];
                
                const colors = ['#ffd700', '#ff6b6b', '#4cc9f0', '#f72585'];
                star.style.color = colors[Math.floor(Math.random() * colors.length)];
                
                star.style.cssText = `
                    left: ${Math.random() * 100}%;
                    font-size: ${Math.random() * 2 + 1}rem;
                    animation-duration: ${Math.random() * 2 + 1}s;
                    color: ${colors[Math.floor(Math.random() * colors.length)]};
                `;
                
                document.getElementById('star-rain').appendChild(star);
                setTimeout(() => star.remove(), 3000);
            }

            // ===== ENHANCED QUESTION GENERATION WITH NO REPEATS =====
            generateQuestion() {
                const level = this.state.level;
                const difficulty = this.state.difficulty;
                
                let a, b, c, answer, question;
                let questionKey;
                let attempts = 0;
                const maxAttempts = 50; // Hadkan percubaan untuk mengelak loop tak terhingga
                
                // Reset usedQuestions jika terlalu banyak (untuk elak isu memori)
                if (this.state.usedQuestions.length > 200) {
                    this.state.usedQuestions = this.state.usedQuestions.slice(-100);
                }
                
                // Terus cuba generate soalan unik sehingga dapat atau mencapai maxAttempts
                do {
                    // Reset untuk percubaan baru
                    question = '';
                    answer = '';
                    
                    // Scale difficulty based on both selected difficulty AND current level
                    const levelMultiplier = Math.min(level, 10); // Cap at level 10
                    
                    switch(difficulty) {
                        case 'easy': // Ages 6-8 - gets harder with levels
                            const op = Math.random() > 0.5 ? '+' : '-';
                            
                            if (level <= 3) {
                                // Level 1-3: Numbers 1-10
                                a = Math.floor(Math.random() * 10) + 1;
                                if (op === '+') {
                                    b = Math.floor(Math.random() * (10 - a)) + 1;
                                    answer = a + b;
                                    question = `${a} + ${b} = ?`;
                                } else {
                                    b = Math.floor(Math.random() * a) + 1;
                                    answer = a - b;
                                    question = `${a} - ${b} = ?`;
                                }
                            } else if (level <= 6) {
                                // Level 4-6: Numbers up to 20
                                a = Math.floor(Math.random() * 15) + 5;
                                if (op === '+') {
                                    b = Math.floor(Math.random() * (15)) + 5;
                                    answer = a + b;
                                    question = `${a} + ${b} = ?`;
                                } else {
                                    b = Math.floor(Math.random() * a) + 1;
                                    answer = a - b;
                                    question = `${a} - ${b} = ?`;
                                }
                            } else {
                                // Level 7-10: Numbers up to 30, three numbers
                                if (Math.random() > 0.5) {
                                    a = Math.floor(Math.random() * 15) + 5;
                                    b = Math.floor(Math.random() * 15) + 5;
                                    c = Math.floor(Math.random() * 10) + 1;
                                    answer = a + b - c;
                                    question = `${a} + ${b} - ${c} = ?`;
                                } else {
                                    a = Math.floor(Math.random() * 20) + 5;
                                    b = Math.floor(Math.random() * 15) + 5;
                                    answer = a + b;
                                    question = `${a} + ${b} = ?`;
                                }
                            }
                            break;
                            
                        case 'medium': // Ages 9-11 - scales with level
                            const op2 = Math.floor(Math.random() * 4);
                            
                            if (level <= 3) {
                                // Level 1-3: Basic multiplication and division
                                if (op2 === 0) {
                                    a = Math.floor(Math.random() * 30) + 10;
                                    b = Math.floor(Math.random() * 30) + 10;
                                    answer = a + b;
                                    question = `${a} + ${b} = ?`;
                                } else if (op2 === 1) {
                                    a = Math.floor(Math.random() * 40) + 20;
                                    b = Math.floor(Math.random() * a) + 1;
                                    answer = a - b;
                                    question = `${a} - ${b} = ?`;
                                } else if (op2 === 2) {
                                    a = Math.floor(Math.random() * 7) + 2;
                                    b = Math.floor(Math.random() * 7) + 2;
                                    answer = a * b;
                                    question = `${a}  ${b} = ?`;
                                } else {
                                    b = Math.floor(Math.random() * 6) + 2;
                                    answer = Math.floor(Math.random() * 6) + 2;
                                    a = answer * b;
                                    question = `${a}  ${b} = ?`;
                                }
                            } else if (level <= 6) {
                                // Level 4-6: Larger numbers, remainders
                                if (op2 === 0) {
                                    a = Math.floor(Math.random() * 70) + 30;
                                    b = Math.floor(Math.random() * 50) + 20;
                                    answer = a + b;
                                    question = `${a} + ${b} = ?`;
                                } else if (op2 === 1) {
                                    a = Math.floor(Math.random() * 80) + 30;
                                    b = Math.floor(Math.random() * 40) + 10;
                                    answer = a - b;
                                    question = `${a} - ${b} = ?`;
                                } else if (op2 === 2) {
                                    a = Math.floor(Math.random() * 10) + 3;
                                    b = Math.floor(Math.random() * 8) + 3;
                                    answer = a * b;
                                    question = `${a}  ${b} = ?`;
                                } else {
                                    b = Math.floor(Math.random() * 7) + 3;
                                    answer = Math.floor(Math.random() * 7) + 3;
                                    a = answer * b + Math.floor(Math.random() * (b - 1));
                                    question = `${a}  ${b} = ? (write remainder in brackets)`;
                                    answer = `${Math.floor(a / b)} r ${a % b}`;
                                }
                            } else {
                                // Level 7-10: Mixed operations
                                if (op2 === 0) {
                                    a = Math.floor(Math.random() * 50) + 50;
                                    b = Math.floor(Math.random() * 40) + 30;
                                    answer = a + b;
                                    question = `${a} + ${b} = ?`;
                                } else if (op2 === 1) {
                                    a = Math.floor(Math.random() * 100) + 50;
                                    b = Math.floor(Math.random() * 60) + 20;
                                    answer = a - b;
                                    question = `${a} - ${b} = ?`;
                                } else if (op2 === 2) {
                                    a = Math.floor(Math.random() * 15) + 5;
                                    b = Math.floor(Math.random() * 12) + 4;
                                    answer = a * b;
                                    question = `${a}  ${b} = ?`;
                                } else {
                                    b = Math.floor(Math.random() * 9) + 4;
                                    answer = Math.floor(Math.random() * 9) + 3;
                                    a = answer * b + Math.floor(Math.random() * (b));
                                    question = `${a}  ${b} = ? (write remainder in brackets)`;
                                    answer = `${Math.floor(a / b)} r ${a % b}`;
                                }
                            }
                            break;
                            
                        case 'hard': // Ages 12-14 - significant level scaling
                            const op3 = Math.floor(Math.random() * 6);
                            
                            if (level <= 3) {
                                // Level 1-3: Introduction to harder concepts
                                if (op3 === 0) {
                                    a = Math.floor(Math.random() * 15) + 10;
                                    b = Math.floor(Math.random() * 8) + 3;
                                    answer = a * b;
                                    question = `${a}  ${b} = ?`;
                                } else if (op3 === 1) {
                                    b = Math.floor(Math.random() * 6) + 3;
                                    answer = Math.floor(Math.random() * 8) + 3;
                                    a = answer * b + Math.floor(Math.random() * 3);
                                    question = `${a}  ${b} = ? (write remainder)`;
                                    answer = `${Math.floor(a / b)} r ${a % b}`;
                                } else if (op3 === 2) {
                                    a = Math.floor(Math.random() * 20) + 5;
                                    answer = Math.floor(a * 0.5);
                                    question = `Calculate 1/2 of ${a} = ?`;
                                } else {
                                    a = Math.floor(Math.random() * 50) + 20;
                                    b = Math.floor(Math.random() * 30) + 10;
                                    answer = a - b;
                                    question = `${a} - ${b} = ?`;
                                }
                            } else if (level <= 6) {
                                // Level 4-6: More complex
                                if (op3 === 0) {
                                    a = Math.floor(Math.random() * 25) + 15;
                                    b = Math.floor(Math.random() * 9) + 4;
                                    answer = a * b;
                                    question = `${a}  ${b} = ?`;
                                } else if (op3 === 1) {
                                    b = Math.floor(Math.random() * 8) + 4;
                                    answer = Math.floor(Math.random() * 10) + 4;
                                    a = answer * b + Math.floor(Math.random() * (b - 1));
                                    question = `${a}  ${b} = ? (remainder)`;
                                    answer = `${Math.floor(a / b)} r ${a % b}`;
                                } else if (op3 === 2) {
                                    a = Math.floor(Math.random() * 100) / 10;
                                    b = Math.floor(Math.random() * 100) / 10;
                                    answer = (a + b).toFixed(1);
                                    question = `${a.toFixed(1)} + ${b.toFixed(1)} = ?`;
                                } else if (op3 === 3) {
                                    a = Math.floor(Math.random() * 80) + 20;
                                    answer = Math.floor(a * 0.2);
                                    question = `Calculate 20% of ${a} = ?`;
                                } else if (op3 === 4) {
                                    a = Math.floor(Math.random() * 10) + 3;
                                    b = Math.floor(Math.random() * 8) + 2;
                                    answer = Math.pow(a, 2);
                                    question = `${a} = ?`;
                                } else {
                                    const length = Math.floor(Math.random() * 8) + 5;
                                    const width = Math.floor(Math.random() * 6) + 4;
                                    answer = 2 * (length + width);
                                    question = `Rectangle length=${length}cm, width=${width}cm. Find perimeter (cm)`;
                                }
                            } else {
                                // Level 7-10: Advanced problems
                                if (op3 === 0) {
                                    a = Math.floor(Math.random() * 30) + 20;
                                    b = Math.floor(Math.random() * 12) + 5;
                                    answer = a * b;
                                    question = `${a}  ${b} = ?`;
                                } else if (op3 === 1) {
                                    b = Math.floor(Math.random() * 9) + 5;
                                    answer = Math.floor(Math.random() * 12) + 5;
                                    a = answer * b + Math.floor(Math.random() * (b));
                                    question = `${a}  ${b} = ? (remainder)`;
                                    answer = `${Math.floor(a / b)} r ${a % b}`;
                                } else if (op3 === 2) {
                                    a = Math.floor(Math.random() * 20) + 5;
                                    b = Math.floor(Math.random() * 15) + 3;
                                    answer = a * b;
                                    question = `Area of rectangle ${a}cm  ${b}cm = ? cm`;
                                } else if (op3 === 3) {
                                    a = Math.floor(Math.random() * 100) + 50;
                                    answer = Math.floor(a * 0.15);
                                    question = `Calculate 15% of ${a} = ?`;
                                } else if (op3 === 4) {
                                    a = Math.floor(Math.random() * 8) + 3;
                                    b = Math.floor(Math.random() * 3) + 2;
                                    answer = Math.pow(a, b);
                                    question = `${a}^${b} = ?`;
                                } else {
                                    const nums = [
                                        Math.floor(Math.random() * 40) + 20,
                                        Math.floor(Math.random() * 40) + 20,
                                        Math.floor(Math.random() * 40) + 20
                                    ];
                                    answer = Math.round((nums[0] + nums[1] + nums[2]) / 3);
                                    question = `Find the average of ${nums[0]}, ${nums[1]}, ${nums[2]}`;
                                }
                            }
                            break;
                            
                        case 'expert': // Ages 15-17 - complex scaling
                            const type = Math.floor(Math.random() * 8);
                            
                            if (level <= 3) {
                                // Level 1-3: Basic algebra and exponents
                                if (type === 0) {
                                    a = Math.floor(Math.random() * 8) + 3;
                                    answer = Math.floor(Math.random() * 8) + 2;
                                    const x = Math.floor(Math.random() * 6) + 2;
                                    question = `Solve: ${a}x + ${x * 2} = ${a * x + x * 2}, find x`;
                                    answer = x;
                                } else if (type === 1) {
                                    answer = Math.floor(Math.random() * 7) + 3;
                                    a = answer * answer;
                                    question = `${a} = ?`;
                                } else if (type === 2) {
                                    const base = Math.floor(Math.random() * 5) + 2;
                                    const exp = 2;
                                    answer = Math.pow(base, exp);
                                    question = `${base}^${exp} = ?`;
                                } else {
                                    const length = Math.floor(Math.random() * 8) + 4;
                                    const width = Math.floor(Math.random() * 6) + 3;
                                    answer = length * width;
                                    question = `Rectangle area: length ${length}cm, width ${width}cm = ? cm`;
                                }
                            } else if (level <= 6) {
                                // Level 4-6: More complex
                                if (type === 0) {
                                    a = Math.floor(Math.random() * 10) + 4;
                                    answer = Math.floor(Math.random() * 10) + 3;
                                    const x = Math.floor(Math.random() * 7) + 3;
                                    question = `Solve: ${a}x - ${x * 3} = ${a * x - x * 3}, find x`;
                                    answer = x;
                                } else if (type === 1) {
                                    answer = Math.floor(Math.random() * 9) + 4;
                                    a = answer * answer;
                                    question = `${a} = ?`;
                                } else if (type === 2) {
                                    const base = Math.floor(Math.random() * 6) + 2;
                                    const exp = Math.floor(Math.random() * 2) + 2;
                                    answer = Math.pow(base, exp);
                                    question = `${base}^${exp} = ?`;
                                } else if (type === 3) {
                                    const nums = [
                                        Math.floor(Math.random() * 30) + 10,
                                        Math.floor(Math.random() * 30) + 10,
                                        Math.floor(Math.random() * 30) + 10
                                    ];
                                    answer = (nums[0] + nums[1] + nums[2]) / 3;
                                    question = `Average of ${nums[0]}, ${nums[1]}, ${nums[2]} = ?`;
                                } else if (type === 4) {
                                    const ratio = Math.floor(Math.random() * 3) + 2;
                                    const part = Math.floor(Math.random() * 8) + 3;
                                    answer = part * ratio;
                                    question = `Ratio A:B is 1:${ratio}. If A = ${part}, find B`;
                                } else {
                                    const principal = Math.floor(Math.random() * 80) + 20;
                                    const rate = Math.random() > 0.5 ? 5 : 8;
                                    const time = Math.floor(Math.random() * 2) + 1;
                                    answer = (principal * rate * time) / 100;
                                    question = `Simple interest: $${principal} at ${rate}% for ${time} year(s). Interest = ?`;
                                }
                            } else {
                                // Level 7-10: Advanced expert problems
                                if (type === 0) {
                                    a = Math.floor(Math.random() * 12) + 5;
                                    answer = Math.floor(Math.random() * 12) + 4;
                                    const x = Math.floor(Math.random() * 9) + 4;
                                    question = `Solve: ${a}x - ${x * 4} = ${a * x - x * 4}, find x`;
                                    answer = x;
                                } else if (type === 1) {
                                    answer = Math.floor(Math.random() * 12) + 5;
                                    a = answer * answer;
                                    question = `${a} = ?`;
                                } else if (type === 2) {
                                    const base = Math.floor(Math.random() * 7) + 3;
                                    const exp = Math.floor(Math.random() * 3) + 2;
                                    answer = Math.pow(base, exp);
                                    question = `${base}^${exp} = ?`;
                                } else if (type === 3) {
                                    const nums = [
                                        Math.floor(Math.random() * 50) + 20,
                                        Math.floor(Math.random() * 50) + 20,
                                        Math.floor(Math.random() * 50) + 20,
                                        Math.floor(Math.random() * 50) + 20
                                    ];
                                    answer = Math.round((nums[0] + nums[1] + nums[2] + nums[3]) / 4);
                                    question = `Average of ${nums[0]}, ${nums[1]}, ${nums[2]}, ${nums[3]}`;
                                } else if (type === 4) {
                                    const a1 = Math.floor(Math.random() * 5) + 2;
                                    const b1 = Math.floor(Math.random() * 5) + 2;
                                    const a2 = Math.floor(Math.random() * 5) + 2;
                                    const b2 = Math.floor(Math.random() * 5) + 2;
                                    answer = (a1 * b2) + (a2 * b1);
                                    question = `Simplify: ${a1}/${b1} + ${a2}/${b2} = ? (numerator only)`;
                                } else if (type === 5) {
                                    const nums = [
                                        Math.floor(Math.random() * 10) + 1,
                                        Math.floor(Math.random() * 10) + 1,
                                        Math.floor(Math.random() * 10) + 1
                                    ];
                                    answer = nums[0] * nums[1] / nums[2];
                                    question = `Calculate: ${nums[0]}  ${nums[1]}  ${nums[2]} = ?`;
                                } else if (type === 6) {
                                    const side = Math.floor(Math.random() * 8) + 4;
                                    answer = side * side * side;
                                    question = `Volume of cube with side ${side}cm = ? cm`;
                                } else {
                                    const start = Math.floor(Math.random() * 15) + 5;
                                    const diff = Math.floor(Math.random() * 5) + 2;
                                    const pos = Math.floor(Math.random() * 3) + 4;
                                    answer = start + (diff * (pos - 1));
                                    question = `Find term ${pos} in sequence: ${start}, ${start + diff}, ${start + diff * 2}, ...`;
                                }
                            }
                            break;
                    }
                    
                    // Generate question key for uniqueness check
                    questionKey = `${question}|${answer}`;
                    attempts++;
                    
                    // Jika dah cuba berkali-kali tapi masih repeat, reset usedQuestions sedikit
                    if (attempts >= maxAttempts / 2 && this.state.usedQuestions.includes(questionKey)) {
                        // Kurangkan separuh dari usedQuestions untuk beri peluang soalan baru
                        this.state.usedQuestions = this.state.usedQuestions.slice(-50);
                    }
                    
                } while (this.state.usedQuestions.includes(questionKey) && attempts < maxAttempts);
                
                // Generate options based on answer type
                let options = new Set();
                
                if (typeof answer === 'number') {
                    options.add(answer.toString());
                    
                    // Generate appropriate wrong answers based on level and difficulty
                    while (options.size < 4) {
                        let wrong;
                        const range = Math.min(5 + level * 2, 15); // Increases with level
                        
                        if (difficulty === 'easy') {
                            wrong = answer + (Math.floor(Math.random() * 5) - 2);
                        } else if (difficulty === 'medium') {
                            wrong = answer + (Math.floor(Math.random() * 7) - 3);
                        } else if (difficulty === 'hard') {
                            wrong = answer + (Math.floor(Math.random() * 11) - 5);
                        } else {
                            wrong = answer + (Math.floor(Math.random() * 15) - 7);
                        }
                        
                        // Adjust for level - higher levels have more challenging wrong answers
                        if (level > 5) {
                            // Include answers that are common mistakes
                            if (Math.random() > 0.5) {
                                wrong = answer + (Math.floor(Math.random() * 3) + 1); // Slightly higher
                            } else {
                                wrong = answer - (Math.floor(Math.random() * 3) + 1); // Slightly lower
                            }
                        }
                        
                        if (wrong > 0 && wrong !== answer && Math.abs(wrong - answer) < range) {
                            options.add(wrong.toString());
                        }
                    }
                } else {
                    // For string answers (like division with remainder)
                    options.add(answer.toString());
                    
                    const possibleWrongs = [
                        answer.split(' ')[0] + ' r 0',
                        answer.split(' ')[0] + ' r ' + (parseInt(answer.split(' ')[2] || 0) + 1),
                        (parseInt(answer.split(' ')[0]) + 1) + ' r 0'
                    ];
                    
                    possibleWrongs.forEach(w => {
                        if (options.size < 4) options.add(w);
                    });
                }
                
                const optionsArray = Array.from(options).sort(() => Math.random() - 0.5);
                
                // Simpan soalan yang telah digunakan
                this.state.usedQuestions.push(questionKey);
                
                return {
                    question: question,
                    answer: answer.toString(),
                    options: optionsArray
                };
            }

            getNewQuestion() {
                return this.generateQuestion();
            }

            generateNewQuestion() {
                this.state.hintUsed = false;
                this.state.retryUsedForCurrent = false;
                this.state.currentQuestionWrongAttempts = 0;
                this.state.pet.dragonCritical = Math.random() < 0.1;
                this.state.pet.fairyHeal = Math.random() < 0.1;
                
                document.getElementById('retry-badge').classList.add('hidden');
                document.getElementById('skip-badge').classList.add('hidden');
                
                const q = this.getNewQuestion();
                if (!q) return;
                
                this.state.currentQuestion = q;
                this.state.waitForNext = false;
                this.displayQuestion();
            }

            displayQuestion() {
                document.getElementById('question').textContent = this.state.currentQuestion.question;
                
                const diffLabels = { easy: 'BEGINNER', medium: 'INTERMEDIATE', hard: 'ADVANCED', expert: 'EXPERT' };
                document.getElementById('difficulty-label').textContent = diffLabels[this.state.difficulty];
                
                document.getElementById('question-level').textContent = this.state.level;
                document.getElementById('question-number').textContent = this.state.questionsAnswered + 1;
                
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                
                this.state.currentQuestion.options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn-pro';
                    btn.textContent = option;
                    btn.onclick = () => this.checkAnswer(option);
                    container.appendChild(btn);
                });
                
                document.getElementById('feedback-text').className = 'feedback-message';
                document.getElementById('feedback-text').classList.remove('show');
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('retry-btn').classList.add('hidden');
                document.getElementById('skip-btn').classList.add('hidden');
                
                this.updateUI();
                this.audio.playSFX('monster');
            }

            checkAnswer(selected) {
                if (!this.state.isGameActive || this.state.isPaused || this.state.waitForNext) return;
                
                clearInterval(this.state.timer);
                
                const isCorrect = selected === this.state.currentQuestion.answer;
                
                document.querySelectorAll('.option-btn-pro').forEach(btn => {
                    if (btn.textContent === selected) {
                        if (isCorrect) {
                            btn.classList.add('correct');
                        } else {
                            btn.classList.add('wrong');
                        }
                    }
                    btn.disabled = true;
                });
                
                if (isCorrect) {
                    this.handleCorrectAnswer();
                } else {
                    this.handleWrongAnswer();
                }
            }

            handleCorrectAnswer() {
                this.state.correctAnswers++; 
                this.state.streak++; 
                this.state.questionsAnswered++; 
                this.state.currentQuestionWrongAttempts = 0;
                
                this.updateCombo();
                
                const baseScore = { easy: 10, medium: 20, hard: 35, expert: 50 }[this.state.difficulty] || 10;
                let score = baseScore * this.state.level + this.state.streak * 5;
                score = Math.floor(score * this.state.combo.multiplier);
                
                let coins = Math.floor(score / 5);
                
                if (this.state.pet.type === 'dragon' && this.state.pet.dragonCritical) { 
                    score *= 2; 
                    this.showSkillEffect(" DOUBLE POINTS!", "#DC143C"); 
                }
                if (this.state.pet.type === 'fairy' && this.state.pet.fairyHeal) { 
                    this.state.heroHealth = Math.min(100, this.state.heroHealth + 5); 
                    this.showSkillEffect(" +5 HP!", "#FF69B4"); 
                }
                if (this.state.pet.type === 'rabbit') { 
                    this.state.timeLeft += 2; 
                    document.getElementById('timer').textContent = this.state.timeLeft; 
                    document.getElementById('compact-timer-value').textContent = this.state.timeLeft; 
                }
                
                if (this.state.currentCharacter === 'explorer') {
                    coins = Math.floor(coins * 1.1);
                }
                if (this.state.explorerDoubleCoins) { 
                    coins *= 2; 
                    this.state.explorerDoubleCoins = false; 
                }
                
                if (this.state.powerups.doublePointsActive) {
                    score *= 2;
                    this.state.powerups.doublePointsRemaining--;
                    if (this.state.powerups.doublePointsRemaining <= 0) {
                        this.state.powerups.doublePointsActive = false;
                    }
                }
                
                this.state.score += score; 
                this.state.coins += coins;
                this.state.currentMonsterHealth -= 100; 
                
                this.showDamageEffect('.enemy', 100);
                this.audio.playSFX('correct'); 
                this.audio.playSFX('sword');
                
                const feedback = document.getElementById('feedback-text');
                feedback.textContent = ` Correct! +${score} points, +${coins} coins `;
                feedback.className = 'feedback-message correct show';
                
                this.createConfetti(5);
                this.state.monstersDefeated++;
                
                this.state.stats.totalQuestions++;
                this.state.stats.correctAnswers++;
                this.state.stats.monstersDefeated++;
                this.state.stats.maxStreak = Math.max(this.state.stats.maxStreak, this.state.streak);
                this.state.stats.totalCoins += coins;
                
                this.updateUI();
                this.checkAchievements();
                this.checkBadges();
                
                if (this.state.timeLeft > 28) {
                    this.state.stats.fastAnswers = (this.state.stats.fastAnswers || 0) + 1;
                }
                
                this.saveStats();
                
                setTimeout(() => { 
                    if (this.state.currentMonsterHealth <= 0) {
                        this.checkGameProgress(); 
                    } else {
                        this.nextQuestion(); 
                    }
                }, 1500);
            }

            handleWrongAnswer() {
                this.state.streak = 0; 
                this.state.questionsAnswered++; 
                this.state.currentQuestionWrongAttempts++; 
                this.state.explorerDoubleCoins = false;
                
                this.resetCombo();
                
                let damage = { easy: 5, medium: 10, hard: 15, expert: 20 }[this.state.difficulty] || 10;
                
                if (this.state.powerups.shieldActive) {
                    damage = 0;
                    this.state.powerups.shieldActive = false;
                    this.showSkillEffect(' Shield blocked damage!', '#4361ee');
                }
                
                if (this.state.pet.type === 'turtle') {
                    damage = Math.max(1, damage - 5);
                }
                
                if (this.state.pet.type === 'phoenix' && this.state.pet.phoenixRevive) {
                    if (this.state.heroHealth - damage <= 0) { 
                        this.state.heroHealth = 1; 
                        this.state.pet.phoenixRevive = false; 
                        this.showSkillEffect(" Saved by Phoenix!", "#FF4500"); 
                        damage = 0; 
                    }
                }
                
                this.state.heroHealth -= damage; 
                if (this.state.heroHealth < 0) this.state.heroHealth = 0;
                
                this.state.stats.totalQuestions++;
                this.state.stats.wrongAnswers++;
                
                this.audio.playSFX('wrong'); 
                this.audio.playSFX('damage'); 
                this.showDamageEffect('.hero', damage);
                
                const feedback = document.getElementById('feedback-text');
                feedback.textContent = ` Wrong answer! -${damage} health`;
                feedback.className = 'feedback-message wrong show';
                
                this.updateUI();
                this.saveStats();
                this.state.waitForNext = true;
                
                if (!this.state.retryUsedForCurrent) {
                    document.getElementById('retry-btn').classList.remove('hidden');
                    document.getElementById('retry-badge').classList.remove('hidden');
                } else {
                    document.getElementById('skip-btn').classList.remove('hidden');
                    document.getElementById('skip-badge').classList.remove('hidden');
                }
                
                if (this.state.heroHealth <= 0) {
                    setTimeout(() => this.gameOver(), 1500);
                }
            }

            gameOver() {
                this.state.isGameActive = false; 
                clearInterval(this.state.timer); 
                
                this.audio.playSFX('gameover');
                
                this.saveToGlobalLeaderboard();
                
                this.state.stats.gamesPlayed++;
                this.state.stats.maxStreak = Math.max(this.state.stats.maxStreak || 0, this.state.streak);
                this.state.stats.maxLevel = Math.max(this.state.stats.maxLevel, this.state.level);
                
                this.saveStats();
                
                document.getElementById('game-over-score').textContent = this.state.score;
                document.getElementById('game-over-level').textContent = this.state.level;
                document.getElementById('game-over-coins').textContent = this.state.coins;
                
                this.checkBadges();
                this.switchScreen('game-over');
            }

            gameCompleted() {
                this.state.isGameActive = false;
                clearInterval(this.state.timer);
                
                this.saveToGlobalLeaderboard();
                
                document.getElementById('congrats-score').textContent = this.state.score;
                document.getElementById('congrats-coins').textContent = this.state.coins;
                
                const accuracy = this.state.questionsAnswered > 0 
                    ? Math.round((this.state.correctAnswers / this.state.questionsAnswered) * 100) 
                    : 0;
                document.getElementById('congrats-accuracy').textContent = accuracy + '%';
                
                // Show level 10 celebration
                this.showLevel10Celebration();
                
                this.createConfetti(50);
                this.audio.playSFX('win');
                this.unlockAchievement('god');
                
                this.switchScreen('congratulations');
            }

            // ===== PET METHODS =====
            updatePetDisplay() {
                const display = document.getElementById('pet-display');
                const icon = document.getElementById('pet-icon');
                const name = document.getElementById('pet-name');
                
                if (this.state.pet.type && display && icon && name) {
                    display.style.display = 'flex';
                    
                    const icons = {
                        dragon: 'fa-dragon',
                        fairy: 'fa-star',
                        phoenix: 'fa-fire',
                        turtle: 'fa-shield-alt',
                        rabbit: 'fa-clock'
                    };
                    
                    icon.className = `fas ${icons[this.state.pet.type]}`;
                    name.textContent = this.pets[this.state.pet.type].name;
                }
            }

            initPetSelection() {
                if (this.state.pet.type) {
                    const petCard = document.querySelector(`[data-pet="${this.state.pet.type}"]`);
                    if (petCard) {
                        petCard.classList.add('selected');
                    }
                }
            }

            // ===== ACHIEVEMENTS =====
            loadAchievements() {
                const saved = localStorage.getItem('mathQuestAchievements');
                if (saved) {
                    this.state.achievements = JSON.parse(saved);
                }
                this.updateAchievementsDisplay();
            }

            updateAchievementsDisplay() {
                const container = document.getElementById('achievements-container');
                if (!container) return;
                
                container.innerHTML = '';
                
                const icons = {
                    wizard_master: 'fa-hat-wizard',
                    knight_defender: 'fa-chess-knight',
                    explorer_rich: 'fa-hiking',
                    first_blood: 'fa-tint',
                    streak_master: 'fa-bolt',
                    perfect_level: 'fa-crown',
                    high_roller: 'fa-star',
                    coin_collector: 'fa-coins',
                    hot_streak: 'fa-fire',
                    invincible: 'fa-shield-alt'
                };
                
                for (const [key, achievement] of Object.entries(this.state.achievements)) {
                    const card = document.createElement('div');
                    card.className = `achievement-card ${achievement.earned ? 'earned' : 'locked'}`;
                    
                    card.innerHTML = `
                        <div class="achievement-icon">
                            <i class="fas ${icons[key] || 'fa-trophy'}"></i>
                        </div>
                        <div class="achievement-info">
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-desc">${achievement.desc}</div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                }
            }

            unlockAchievement(key) {
                if (!this.state.achievements[key].earned) {
                    this.state.achievements[key].earned = true;
                    localStorage.setItem('mathQuestAchievements', JSON.stringify(this.state.achievements));
                    this.updateAchievementsDisplay();
                    this.showToast(` Achievement: ${this.state.achievements[key].name}!`);
                    this.audio.playSFX('levelup');
                }
            }

            checkAchievements() {
                if (this.state.monstersDefeated >= 1) this.unlockAchievement('first_blood');
                if (this.state.streak >= 5) this.unlockAchievement('streak_master');
                if (this.state.streak >= 10) this.unlockAchievement('hot_streak');
                if (this.state.score >= 1000) this.unlockAchievement('high_roller');
                if (this.state.coins >= 500) this.unlockAchievement('coin_collector');
                if (this.state.level >= 5) this.unlockAchievement('invincible');
                
                if (this.state.currentCharacter === 'wizard' && this.state.level >= 3) {
                    this.unlockAchievement('wizard_master');
                }
                if (this.state.currentCharacter === 'knight' && this.state.level >= 3) {
                    this.unlockAchievement('knight_defender');
                }
                if (this.state.currentCharacter === 'explorer' && this.state.level >= 3) {
                    this.unlockAchievement('explorer_rich');
                }
                if (this.state.heroHealth >= 100 && this.state.monstersDefeated >= 5) {
                    this.unlockAchievement('perfect_level');
                }
            }

            // ===== SHOP METHODS =====
            initShop() {
                this.updateShopDisplay();
            }

            updateShopDisplay() {
                const container = document.getElementById('shop-items');
                if (!container) return;
                
                container.innerHTML = '';
                document.getElementById('shop-coins').textContent = this.state.coins;
                
                this.state.shop.items.forEach(item => {
                    const owned = this.state.shop.inventory.includes(item.id);
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `shop-item ${owned ? 'purchased' : ''}`;
                    
                    itemDiv.innerHTML = `
                        <div class="shop-item-icon"><i class="fas ${item.icon}"></i></div>
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-desc">${item.desc}</div>
                        <div class="shop-item-price">
                            <i class="fas fa-coins"></i> ${item.price}
                        </div>
                        ${owned ? '<div class="shop-item-badge">OWNED</div>' : ''}
                    `;
                    
                    if (!owned) {
                        itemDiv.addEventListener('click', () => this.purchaseItem(item));
                    }
                    
                    container.appendChild(itemDiv);
                });
            }

            purchaseItem(item) {
                if (this.state.coins < item.price) {
                    this.showToast(' Not enough coins!');
                    this.audio.playSFX('wrong');
                    return;
                }
                
                this.state.coins -= item.price;
                this.state.stats.totalCoins += item.price;
                
                this.state.shop.inventory.push(item.id);
                localStorage.setItem('mathQuestInventory', JSON.stringify(this.state.shop.inventory));
                
                this.useConsumable(item);
                
                this.updateShopDisplay();
                this.updateUI();
                this.showToast(` Purchased and used: ${item.name}!`);
                this.audio.playSFX('coin');
                this.createConfetti(5);
                
                this.saveStats();
            }

            useConsumable(item) {
                switch(item.effect) {
                    case 'heal':
                        this.state.heroHealth = Math.min(100, this.state.heroHealth + 25);
                        this.showSkillEffect(' +25 HP!', '#4caf50');
                        break;
                    case 'fullheal':
                        this.state.heroHealth = 100;
                        this.showSkillEffect(' FULL HEAL!', '#4caf50');
                        break;
                    case 'time':
                        this.state.timeLeft += 15;
                        document.getElementById('timer').textContent = this.state.timeLeft;
                        document.getElementById('compact-timer-value').textContent = this.state.timeLeft;
                        this.showSkillEffect(' +15 Seconds!', '#4cc9f0');
                        break;
                    case 'extratime':
                        this.state.timeLeft += 30;
                        document.getElementById('timer').textContent = this.state.timeLeft;
                        document.getElementById('compact-timer-value').textContent = this.state.timeLeft;
                        this.showSkillEffect(' +30 Seconds!', '#4cc9f0');
                        break;
                    case 'shield':
                        this.state.powerups.shieldActive = true;
                        this.showSkillEffect(' Shield Active!', '#4361ee');
                        break;
                    case 'double':
                        this.state.powerups.doublePointsActive = true;
                        this.state.powerups.doublePointsRemaining = 3;
                        this.showSkillEffect(' Double Points!', '#ffd700');
                        break;
                }
                this.updateUI();
            }

            // ===== BADGES =====
            initBadges() {
                this.updateBadgesDisplay();
            }

            updateBadgesDisplay() {
                const container = document.getElementById('badges-container');
                if (!container) return;
                
                container.innerHTML = '';
                
                Object.entries(this.state.badges).forEach(([key, badge]) => {
                    const earned = this.checkBadgeEarned(key);
                    
                    const badgeDiv = document.createElement('div');
                    badgeDiv.className = `achievement-badge ${earned ? 'earned' : 'locked'}`;
                    
                    badgeDiv.innerHTML = `
                        <div class="badge-icon"><i class="fas ${badge.icon}"></i></div>
                        <div class="badge-level">Lv.${badge.level}</div>
                        <div class="badge-tooltip">
                            <strong>${badge.name}</strong><br>
                            ${badge.desc}
                        </div>
                    `;
                    
                    container.appendChild(badgeDiv);
                });
            }

            checkBadgeEarned(key) {
                switch(key) {
                    case 'novice':
                        return this.state.stats.totalQuestions >= 10;
                    case 'warrior':
                        return this.state.stats.monstersDefeated >= 20;
                    case 'master':
                        return this.state.level >= 5;
                    case 'legend':
                        return this.state.score >= 5000;
                    case 'god':
                        return this.state.level >= 10;
                    default:
                        return false;
                }
            }

            checkBadges() {
                this.updateBadgesDisplay();
            }

            // ===== DAILY REWARD =====
            checkDailyReward() {
                const today = new Date().toDateString();
                const lastClaimed = this.state.dailyReward.lastClaimed;
                const timerEl = document.getElementById('reward-timer');
                const rewardBtn = document.getElementById('daily-reward-btn');
                
                if (lastClaimed !== today) {
                    this.state.dailyReward.available = true;
                    if (timerEl) {
                        timerEl.innerHTML = '<i class="fas fa-gift" style="color: var(--warning);"></i> <span style="color: var(--warning); font-weight: bold;">Reward available!</span> Claim now!';
                        timerEl.style.animation = 'selectedPulse 2s infinite';
                    }
                    if (rewardBtn) {
                        rewardBtn.classList.add('reward-available');
                    }
                } else {
                    this.state.dailyReward.available = false;
                    
                    const now = new Date();
                    const midnight = new Date(now);
                    midnight.setDate(midnight.getDate() + 1);
                    midnight.setHours(0, 0, 0, 0);
                    
                    const timeUntilMidnight = midnight - now;
                    const hoursLeft = Math.floor(timeUntilMidnight / (1000 * 60 * 60));
                    const minutesLeft = Math.floor((timeUntilMidnight % (1000 * 60 * 60)) / (1000 * 60));
                    
                    if (timerEl) {
                        timerEl.innerHTML = ` Next reward in ${hoursLeft}h ${minutesLeft}m`;
                        timerEl.style.animation = 'none';
                    }
                    if (rewardBtn) {
                        rewardBtn.classList.remove('reward-available');
                    }
                }
            }

            claimDailyReward() {
                if (this.state.dailyReward.available) {
                    const baseReward = 50;
                    const streakBonus = this.state.dailyReward.streak * 10;
                    const totalReward = baseReward + streakBonus;
                    
                    this.state.coins += totalReward;
                    
                    this.state.dailyReward.lastClaimed = new Date().toDateString();
                    this.state.dailyReward.streak++;
                    this.state.dailyReward.available = false;
                    
                    localStorage.setItem('mathQuestLastReward', this.state.dailyReward.lastClaimed);
                    localStorage.setItem('mathQuestRewardStreak', this.state.dailyReward.streak);
                    
                    this.updateUI();
                    this.checkDailyReward();
                    
                    this.showToast(` Daily Reward: +${totalReward} coins! (Day ${this.state.dailyReward.streak})`);
                    
                    this.audio.playSFX('coin');
                    this.createCoinEffect(10);
                    
                    const btn = document.getElementById('daily-reward-btn');
                    btn.style.animation = 'rewardPulse 0.5s 3';
                    setTimeout(() => btn.style.animation = '', 1500);
                } else {
                    this.showToast(" Daily reward already claimed today!");
                    this.audio.playSFX('wrong');
                }
            }

            createCoinEffect(count) {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const coin = document.createElement('div');
                        coin.className = 'coin-effect';
                        coin.style.left = Math.random() * 100 + '%';
                        coin.style.background = i % 2 === 0 ? 'gold' : '#ffd700';
                        document.body.appendChild(coin);
                        setTimeout(() => coin.remove(), 1500);
                    }, i * 50);
                }
            }

            // ===== STATISTICS =====
            showStatistics() {
                const accuracy = this.state.stats.totalQuestions > 0 
                    ? Math.round((this.state.stats.correctAnswers / this.state.stats.totalQuestions) * 100) 
                    : 0;
                
                document.getElementById('stat-games').textContent = this.state.stats.gamesPlayed;
                document.getElementById('stat-questions').textContent = this.state.stats.totalQuestions;
                document.getElementById('stat-correct').textContent = this.state.stats.correctAnswers;
                document.getElementById('stat-wrong').textContent = this.state.stats.wrongAnswers;
                document.getElementById('stat-accuracy').textContent = accuracy + '%';
                document.getElementById('stat-monsters').textContent = this.state.stats.monstersDefeated;
                document.getElementById('stat-maxlevel').textContent = this.state.stats.maxLevel;
                document.getElementById('stat-time').textContent = Math.floor(this.state.stats.playTime) + 'm';
                
                this.switchScreen('stats');
            }

            updateStatisticsDisplay() {
                setInterval(() => {
                    if (this.state.isGameActive) {
                        this.state.stats.playTime += 1;
                        localStorage.setItem('mathQuestPlayTime', this.state.stats.playTime);
                    }
                }, 60000);
            }

            saveStats() {
                localStorage.setItem('mathQuestGames', this.state.stats.gamesPlayed);
                localStorage.setItem('mathQuestQuestions', this.state.stats.totalQuestions);
                localStorage.setItem('mathQuestCorrect', this.state.stats.correctAnswers);
                localStorage.setItem('mathQuestWrong', this.state.stats.wrongAnswers);
                localStorage.setItem('mathQuestMonsters', this.state.stats.monstersDefeated);
                localStorage.setItem('mathQuestMaxLevel', this.state.stats.maxLevel);
                localStorage.setItem('mathQuestPlayTime', this.state.stats.playTime);
                localStorage.setItem('mathQuestTotalCoins', this.state.stats.totalCoins);
                localStorage.setItem('mathQuestMaxStreak', this.state.stats.maxStreak);
                localStorage.setItem('mathQuestFastAnswers', this.state.stats.fastAnswers);
            }

            // ===== GLOBAL LEADERBOARD METHODS =====
            loadGlobalLeaderboard(difficulty) {
                const container = document.getElementById('global-leaderboard-list');
                if (!container) return;
                
                const allScores = JSON.parse(localStorage.getItem('mathQuestLeaderboard')) || [];
                const filteredScores = allScores.filter(score => score.difficulty === difficulty)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 10);
                
                this.displayGlobalLeaderboard(filteredScores, difficulty);
            }

            displayGlobalLeaderboard(scores, difficulty) {
                const container = document.getElementById('global-leaderboard-list');
                if (!container) return;
                
                if (!scores || scores.length === 0) {
                    container.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center; padding:40px;">No scores yet. Be the first!</div>';
                    return;
                }
                
                container.innerHTML = '';
                
                scores.forEach((score, index) => {
                    const icons = { wizard: 'fa-hat-wizard', knight: 'fa-chess-knight', explorer: 'fa-hiking' };
                    
                    const scoreDiv = document.createElement('div');
                    scoreDiv.style.cssText = `
                        background: rgba(255,255,255,0.05);
                        border: 1px solid var(--glass-border);
                        border-radius: 15px;
                        padding: 15px 20px;
                        margin-bottom: 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        transition: var(--transition-smooth);
                        ${index === 0 ? 'border-color: var(--warning); box-shadow: 0 0 20px rgba(255,215,0,0.2);' : ''}
                    `;
                    
                    const date = new Date(score.timestamp).toLocaleDateString('en-US');
                    
                    scoreDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 40px; height: 40px; background: ${index < 3 ? 'linear-gradient(145deg, var(--primary), var(--secondary))' : 'rgba(255,255,255,0.1)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron';">
                                ${index + 1}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${score.name}</div>
                                <div style="color: rgba(255,255,255,0.6); font-size: 0.8rem;">
                                    Level ${score.level}  ${date}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-family: 'Orbitron'; font-size: 1.2rem; color: var(--accent);">
                                ${score.score.toLocaleString()}
                            </div>
                            <i class="fas ${icons[score.character] || 'fa-user'}" style="color: var(--accent);"></i>
                        </div>
                    `;
                    
                    container.appendChild(scoreDiv);
                });
            }

            saveToGlobalLeaderboard() {
                if (!this.state.playerName || this.state.score === 0) return;
                
                const scoreData = {
                    name: this.state.playerName,
                    score: this.state.score,
                    level: this.state.level,
                    character: this.state.currentCharacter,
                    difficulty: this.state.difficulty,
                    timestamp: Date.now()
                };
                
                const allScores = JSON.parse(localStorage.getItem('mathQuestLeaderboard')) || [];
                allScores.push(scoreData);
                
                const groupedScores = {};
                allScores.forEach(score => {
                    if (!groupedScores[score.difficulty]) groupedScores[score.difficulty] = [];
                    groupedScores[score.difficulty].push(score);
                });
                
                Object.keys(groupedScores).forEach(diff => {
                    groupedScores[diff].sort((a, b) => b.score - a.score);
                    if (groupedScores[diff].length > 50) {
                        groupedScores[diff] = groupedScores[diff].slice(0, 50);
                    }
                });
                
                const finalScores = [];
                Object.values(groupedScores).forEach(scores => {
                    finalScores.push(...scores);
                });
                
                localStorage.setItem('mathQuestLeaderboard', JSON.stringify(finalScores));
                
                this.loadGlobalLeaderboard(this.state.difficulty);
            }

            // ===== GAME FLOW =====
            showNameEntry() {
                this.audio.playSFX('click');
                this.switchScreen('name-entry');
                setTimeout(() => document.getElementById('player-name').focus(), 300);
            }

            startGame() {
                const name = document.getElementById('player-name').value.trim();
                
                if (!name) {
                    document.getElementById('player-name').style.borderColor = 'var(--danger)';
                    setTimeout(() => {
                        document.getElementById('player-name').style.borderColor = 'var(--accent)';
                    }, 500);
                    return;
                }
                
                this.state.playerName = name;
                localStorage.setItem('mathQuestPlayerName', name);
                
                this.resetGame();
                this.state.isGameActive = true;
                
                if (this.state.currentCharacter === 'knight') {
                    this.state.heroHealth = 110;
                }
                
                this.updatePetDisplay();
                
                this.switchScreen('game');
                this.generateNewQuestion();
                this.startTimer();
                
                this.audio.playMusic();
                this.audio.playSFX('hero');
            }

            retryQuestion() {
                if (!this.state.isGameActive || this.state.isPaused || this.state.retryUsedForCurrent) return;
                
                this.state.retryUsedForCurrent = true;
                this.state.timeLeft = Math.max(5, 30 - (this.state.currentQuestionWrongAttempts * 8));
                
                document.getElementById('timer').textContent = this.state.timeLeft;
                document.getElementById('compact-timer-value').textContent = this.state.timeLeft;
                document.getElementById('retry-btn').classList.add('hidden');
                
                document.querySelectorAll('.option-btn-pro').forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('correct', 'wrong', 'hint-removed');
                });
                
                document.getElementById('feedback-text').classList.remove('show');
                
                clearInterval(this.state.timer);
                this.startTimer();
                this.state.waitForNext = false;
                
                this.showToast(" Retry attempt! Same question, try again!");
                this.audio.playSFX('click');
                
                this.state.currentQuestionWrongAttempts = 0;
            }

            skipQuestion() {
                if (!this.state.isGameActive || this.state.isPaused) return;
                
                const damage = 5;
                this.state.heroHealth -= damage;
                
                if (this.state.heroHealth < 0) this.state.heroHealth = 0;
                
                this.audio.playSFX('damage');
                this.showDamageEffect('.hero', damage);
                this.showToast(` Skipped! -${damage} health`);
                
                document.getElementById('skip-btn').classList.add('hidden');
                document.getElementById('skip-badge').classList.add('hidden');
                
                this.nextQuestion();
            }

            nextQuestion() {
                this.state.currentMonsterHealth = 100;
                document.getElementById('enemy-health').style.width = '100%';
                
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('retry-btn').classList.add('hidden');
                document.getElementById('skip-btn').classList.add('hidden');
                
                this.state.waitForNext = false;
                
                document.getElementById('retry-badge').classList.add('hidden');
                document.getElementById('skip-badge').classList.add('hidden');
                
                if (this.state.monstersDefeated >= this.state.monstersPerLevel) {
                    this.completeLevel();
                } else {
                    this.generateNewQuestion();
                    this.startTimer();
                }
            }

            updateUI() {
                document.getElementById('current-level').textContent = this.state.level;
                document.getElementById('current-score').textContent = this.state.score;
                document.getElementById('coins').textContent = this.state.coins;
                document.getElementById('streak').textContent = this.state.streak;
                
                document.getElementById('correct-count').textContent = this.state.correctAnswers;
                document.getElementById('wrong-count').textContent = this.state.questionsAnswered - this.state.correctAnswers;
                
                const accuracy = this.state.questionsAnswered > 0 
                    ? Math.round((this.state.correctAnswers / this.state.questionsAnswered) * 100) 
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                document.getElementById('enemy-health').style.width = this.state.currentMonsterHealth + '%';
                document.getElementById('hero-health').style.width = this.state.heroHealth + '%';
                
                const progress = (this.state.monstersDefeated / this.state.monstersPerLevel) * 100;
                document.getElementById('level-progress').style.width = progress + '%';
                document.getElementById('progress-text').textContent = `${this.state.monstersDefeated}/${this.state.monstersPerLevel} Monsters`;
            }

            checkGameProgress() {
                if (this.state.monstersDefeated >= this.state.monstersPerLevel) {
                    setTimeout(() => this.completeLevel(), 1500);
                } else if (this.state.heroHealth <= 0) {
                    setTimeout(() => this.gameOver(), 1500);
                } else {
                    this.nextQuestion();
                }
            }

            completeLevel() {
                this.state.isGameActive = false;
                clearInterval(this.state.timer);
                
                if (this.state.level >= this.state.maxLevel) {
                    this.gameCompleted();
                    return;
                }
                
                const multiplier = { easy: 1, medium: 1.5, hard: 2, expert: 3 }[this.state.difficulty] || 1;
                const timeBonus = Math.max(0, this.state.timeLeft) * 3 * multiplier;
                const levelBonus = this.state.level * 100 * multiplier;
                const totalCoins = Math.floor(100 * multiplier) + (this.state.level * 25);
                const totalScore = Math.floor(500 * multiplier) + timeBonus + levelBonus;
                
                let finalCoins = totalCoins;
                if (this.state.currentCharacter === 'explorer') {
                    finalCoins = Math.floor(totalCoins * 1.1);
                }
                
                this.state.coins += finalCoins;
                this.state.score += totalScore;
                
                document.getElementById('level-complete-score').textContent = this.state.score;
                document.getElementById('level-complete-coins').textContent = finalCoins;
                
                const accuracy = this.state.questionsAnswered > 0 
                    ? Math.round((this.state.correctAnswers / this.state.questionsAnswered) * 100) 
                    : 0;
                document.getElementById('level-complete-accuracy').textContent = accuracy + '%';
                
                this.state.level++;
                this.state.monstersDefeated = 0;
                this.state.currentMonsterHealth = 100;
                this.state.usedQuestions = [];
                this.state.pet.phoenixRevive = true;
                
                if (this.state.currentCharacter === 'wizard') this.unlockAchievement('wizard_master');
                if (this.state.currentCharacter === 'knight') this.unlockAchievement('knight_defender');
                if (this.state.currentCharacter === 'explorer') this.unlockAchievement('explorer_rich');
                if (this.state.heroHealth >= 100) this.unlockAchievement('perfect_level');
                
                this.audio.playSFX('levelup');
                this.createConfetti(20);
                
                this.switchScreen('level-complete');
            }

            continueToNextLevel() {
                this.state.heroHealth = this.state.currentCharacter === 'knight' ? 110 : 100;
                this.state.questionsAnswered = 0;
                this.state.correctAnswers = 0;
                this.state.timeLeft = 30;
                this.state.streak = 0;
                this.state.waitForNext = false;
                this.state.explorerDoubleCoins = false;
                this.state.skillUsed = false;
                this.state.hintUsed = false;
                this.state.retryUsedForCurrent = false;
                
                this.updateSkillButton();
                this.updateUI();
                
                this.switchScreen('game');
                this.state.isGameActive = true;
                
                this.generateNewQuestion();
                this.startTimer();
            }

            // ===== SKILLS =====
            updateSkillButton() {
                const btn = document.getElementById('hero-skill-btn');
                const icon = document.getElementById('skill-icon');
                const text = document.getElementById('skill-text');
                
                const skill = this.skills[this.state.currentCharacter];
                
                if (icon) icon.className = skill.icon;
                btn.disabled = this.state.skillUsed;
                text.textContent = this.state.skillUsed ? "Used" : skill.name;
            }

            useHeroSkill() {
                if (this.state.skillUsed || !this.state.isGameActive || this.state.isPaused) return;
                
                this.skills[this.state.currentCharacter].effect();
                this.state.skillUsed = true;
                
                this.updateSkillButton();
                this.audio.playSFX('hero');
            }

            wizardSkill() {
                this.state.timeLeft += 10;
                document.getElementById('timer').textContent = this.state.timeLeft;
                document.getElementById('compact-timer-value').textContent = this.state.timeLeft;
                this.showSkillEffect(" +10 Seconds!", "#f72585");
            }

            knightSkill() {
                const maxHealth = this.state.currentCharacter === 'knight' ? 110 : 100;
                const healAmount = Math.floor(maxHealth * 0.3);
                this.state.heroHealth = Math.min(maxHealth, this.state.heroHealth + healAmount);
                this.showSkillEffect(` +${healAmount} HP!`, "#4361ee");
                this.updateUI();
            }

            explorerSkill() {
                this.state.explorerDoubleCoins = true;
                this.showSkillEffect(" Next: Double Coins!", "#ffd700");
                
                document.querySelectorAll('.option-btn-pro').forEach(btn => {
                    btn.style.boxShadow = '0 0 20px gold';
                    btn.style.borderColor = '#ffd700';
                    btn.style.transition = 'var(--transition-smooth)';
                });
                
                setTimeout(() => {
                    if (this.state.explorerDoubleCoins) {
                        document.querySelectorAll('.option-btn-pro').forEach(btn => {
                            btn.style.boxShadow = '';
                            btn.style.borderColor = 'var(--glass-border)';
                        });
                    }
                }, 5000);
            }

            // ===== HINT & POWERUPS =====
            showHint() {
                if (this.state.hintUsed) {
                    this.showToast(" Hint already used!");
                    return;
                }
                
                if (this.state.coins >= 50) {
                    this.state.coins -= 50;
                    this.state.hintUsed = true;
                    this.updateUI();
                    
                    const correct = this.state.currentQuestion.answer;
                    const options = document.querySelectorAll('.option-btn-pro');
                    const wrongOptions = Array.from(options).filter(btn => btn.textContent !== correct);
                    
                    if (wrongOptions.length >= 2) {
                        const shuffled = wrongOptions.sort(() => 0.5 - Math.random());
                        shuffled[0].classList.add('hint-removed');
                        shuffled[0].disabled = true;
                        shuffled[1].classList.add('hint-removed');
                        shuffled[1].disabled = true;
                    }
                    
                    this.showToast(" 2 wrong answers removed!");
                    this.audio.playSFX('click');
                } else {
                    this.showToast(" Need 50 coins!");
                }
            }

            usePowerup() {
                if (this.state.coins >= 150) {
                    this.state.coins -= 150;
                    this.state.timeLeft += 5;
                    
                    document.getElementById('timer').textContent = this.state.timeLeft;
                    document.getElementById('compact-timer-value').textContent = this.state.timeLeft;
                    
                    this.updateUI();
                    this.showSkillEffect(" +5 Seconds!", "#4ECDC4");
                    this.audio.playSFX('levelup');
                } else {
                    this.showToast(" Need 150 coins!");
                }
            }

            // ===== TIMER =====
            startTimer() {
                clearInterval(this.state.timer);
                
                if (this.state.currentQuestionWrongAttempts === 0) {
                    this.state.timeLeft = 30;
                }
                
                document.getElementById('timer').textContent = this.state.timeLeft;
                document.getElementById('compact-timer-value').textContent = this.state.timeLeft;
                
                const compactTimer = document.getElementById('compact-timer');
                
                this.state.timer = setInterval(() => {
                    if (!this.state.isPaused && this.state.isGameActive && !this.state.waitForNext) {
                        this.state.timeLeft--;
                        
                        document.getElementById('timer').textContent = this.state.timeLeft;
                        document.getElementById('compact-timer-value').textContent = this.state.timeLeft;
                        
                        if (this.state.timeLeft <= 10) {
                            compactTimer.classList.add('warning');
                            if (this.state.timeLeft === 5) {
                                this.audio.playSFX('timewarning');
                            }
                        } else {
                            compactTimer.classList.remove('warning');
                        }
                        
                        if (this.state.timeLeft <= 0) {
                            clearInterval(this.state.timer);
                            this.handleTimeOut();
                        }
                    }
                }, 1000);
            }

            handleTimeOut() {
                const damage = 15;
                this.state.heroHealth -= damage;
                
                this.audio.playSFX('wrong');
                this.audio.playSFX('damage');
                this.showDamageEffect('.hero', damage);
                
                this.state.currentQuestionWrongAttempts++;
                
                if (this.state.heroHealth <= 0) {
                    this.gameOver();
                } else {
                    this.showToast(" Time's up! Monster attacks!");
                    this.state.waitForNext = true;
                    
                    if (!this.state.retryUsedForCurrent) {
                        document.getElementById('retry-btn').classList.remove('hidden');
                    } else {
                        document.getElementById('skip-btn').classList.remove('hidden');
                    }
                    
                    document.getElementById('next-btn').classList.add('hidden');
                    document.getElementById('retry-badge').classList.remove('hidden');
                }
                
                this.updateUI();
            }

            // ===== PAUSE/RESUME =====
            pauseGame() {
                if (this.state.isGameActive) {
                    this.state.isPaused = true;
                    clearInterval(this.state.timer);
                    this.audio.stopMusic();
                    this.switchScreen('pause');
                }
            }

            resumeGame() {
                this.state.isPaused = false;
                this.switchScreen('game');
                this.audio.playMusic();
                this.startTimer();
            }

            restartLevel() {
                this.state.heroHealth = this.state.currentCharacter === 'knight' ? 110 : 100;
                this.state.skillUsed = false;
                this.state.explorerDoubleCoins = false;
                this.state.monstersDefeated = 0;
                this.state.questionsAnswered = 0;
                this.state.correctAnswers = 0;
                this.state.timeLeft = 30;
                this.state.streak = 0;
                this.state.waitForNext = false;
                this.state.hintUsed = false;
                this.state.currentQuestionWrongAttempts = 0;
                this.state.retryUsedForCurrent = false;
                this.state.usedQuestions = [];
                this.state.currentMonsterHealth = 100;
                this.state.pet.phoenixRevive = true;
                
                this.updateUI();
                this.updateSkillButton();
                
                this.switchScreen('game');
                this.state.isGameActive = true;
                
                this.generateNewQuestion();
                this.startTimer();
            }

            quitToMenu() {
                this.resetGame();
                this.loadGlobalLeaderboard('easy');
                this.audio.stopMusic();
                this.switchScreen('start');
            }

            resetGame() {
                this.state.score = 0;
                this.state.coins = 500;
                this.state.level = 1;
                this.state.heroHealth = 100;
                this.state.questionsAnswered = 0;
                this.state.correctAnswers = 0;
                this.state.monstersDefeated = 0;
                this.state.streak = 0;
                this.state.isGameActive = false;
                this.state.isPaused = false;
                this.state.waitForNext = false;
                this.state.skillUsed = false;
                this.state.explorerDoubleCoins = false;
                this.state.hintUsed = false;
                this.state.currentQuestionWrongAttempts = 0;
                this.state.retryUsedForCurrent = false;
                this.state.usedQuestions = [];
                this.state.currentMonsterHealth = 100;
                this.state.pet.phoenixRevive = true;
                
                this.state.powerups = {
                    shieldActive: false,
                    doublePointsActive: false,
                    doublePointsRemaining: 0
                };
                
                this.updateUI();
                document.getElementById('level-progress').style.width = '0%';
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('retry-btn').classList.add('hidden');
                document.getElementById('skip-btn').classList.add('hidden');
                document.getElementById('retry-badge').classList.add('hidden');
                document.getElementById('skip-badge').classList.add('hidden');
                
                this.updateSkillButton();
            }

            // ===== COMBO SYSTEM =====
            startComboTimer() {
                this.state.combo.timer = setInterval(() => {
                    if (this.state.combo.active && this.state.combo.count > 0) {
                        this.state.combo.timeLeft -= 0.1;
                        const percent = (this.state.combo.timeLeft / 5) * 100;
                        document.getElementById('combo-timer-fill').style.width = Math.max(0, percent) + '%';
                        
                        if (this.state.combo.timeLeft <= 0) {
                            this.resetCombo();
                        }
                    }
                }, 100);
            }

            updateCombo() {
                this.state.combo.count++;
                this.state.combo.timeLeft = 5;
                this.state.combo.active = true;
                
                if (this.state.combo.count >= 10) this.state.combo.multiplier = 3.0;
                else if (this.state.combo.count >= 5) this.state.combo.multiplier = 2.0;
                else if (this.state.combo.count >= 3) this.state.combo.multiplier = 1.5;
                else this.state.combo.multiplier = 1.0;
                
                document.getElementById('combo-meter').style.display = 'block';
                document.getElementById('combo-count').textContent = this.state.combo.count;
                document.getElementById('combo-multiplier').textContent = this.state.combo.multiplier.toFixed(1) + 'x';
                
                if (this.state.combo.count >= 5) {
                    this.showComboPop(this.state.combo.count);
                    this.audio.playSFX('combo');
                    this.createConfetti(3);
                }
            }

            resetCombo() {
                this.state.combo.count = 0;
                this.state.combo.multiplier = 1.0;
                this.state.combo.active = false;
                document.getElementById('combo-meter').style.display = 'none';
            }

            showComboPop(combo) {
                const pop = document.createElement('div');
                pop.className = 'combo-pop';
                pop.textContent = `${combo}x COMBO!`;
                pop.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-family: 'Orbitron', sans-serif;
                    font-size: 4rem;
                    font-weight: 900;
                    color: var(--warning);
                    text-shadow: 0 0 30px var(--warning);
                    z-index: 1000;
                    pointer-events: none;
                    animation: comboPop 1s ease-out forwards;
                `;
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes comboPop {
                        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
                        20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
                        80% { opacity: 1; transform: translate(-50%, -150%) scale(1); }
                        100% { opacity: 0; transform: translate(-50%, -200%) scale(0.5); }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(pop);
                setTimeout(() => pop.remove(), 1000);
            }

            // ===== VISUAL EFFECTS =====
            createConfetti(count) {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti-piece';
                        
                        const colors = ['#f72585', '#4361ee', '#4cc9f0', '#ff6b6b', '#ffd700', '#4caf50'];
                        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
                        confetti.style.width = (Math.random() * 10 + 5) + 'px';
                        confetti.style.height = (Math.random() * 10 + 5) + 'px';
                        
                        document.body.appendChild(confetti);
                        
                        setTimeout(() => confetti.remove(), 3000);
                    }, i * 50);
                }
            }

            showDamageEffect(target, damage) {
                const element = document.querySelector(target);
                if (!element) return;
                
                const damageText = document.createElement('div');
                damageText.textContent = `-${damage}`;
                damageText.style.cssText = `
                    position: absolute;
                    color: ${target === '.enemy' ? '#4caf50' : '#ff6b6b'};
                    font-family: 'Orbitron', sans-serif;
                    font-size: 2rem;
                    font-weight: 900;
                    animation: damageFloat 1s ease-out forwards;
                    pointer-events: none;
                    text-shadow: 0 0 10px ${target === '.enemy' ? '#4caf50' : '#ff6b6b'};
                    z-index: 100;
                `;
                
                element.style.position = 'relative';
                element.appendChild(damageText);
                setTimeout(() => damageText.remove(), 1000);
            }

            showSkillEffect(message, color) {
                const effect = document.createElement('div');
                effect.className = 'skill-effect';
                effect.textContent = message;
                effect.style.color = color;
                
                document.body.appendChild(effect);
                setTimeout(() => effect.remove(), 2000);
            }

            showMessage(message) {
                const feedback = document.getElementById('feedback-text');
                if (feedback) {
                    feedback.textContent = message;
                    feedback.className = 'feedback-message show';
                    setTimeout(() => feedback.classList.remove('show'), 3000);
                }
            }

            showHowToPlay() {
                this.audio.playSFX('click');
                this.switchScreen('how-to-play');
            }

            switchScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId + '-screen').classList.add('active');
            }

            updateCharacterIcons() {
                const icons = {
                    wizard: 'fa-hat-wizard',
                    knight: 'fa-chess-knight',
                    explorer: 'fa-hiking'
                };
                
                const iconClass = icons[this.state.currentCharacter];
                
                document.getElementById('hero-icon').className = `fas ${iconClass} combatant-icon hero-icon`;
                document.getElementById('current-char-icon').className = `fas ${iconClass}`;
            }
        }

        // Initialize game when page loads
        window.addEventListener('DOMContentLoaded', () => {
            window.game = new MathQuestAdventure();
        });
    </script>
</body>
</html>